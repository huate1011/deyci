"use strict";var common=getApp().globalData.commonFun,util=getApp().globalData.utilFun,dpTemp=require("../../../commonPage/zhuanlan/temp.js");Page({data:{interfaceName:"mySubscription",currentTab:0,requestStatus:!1,info:{zhuanlanList:[]},danpinList:[]},state:{limit:10,offset:0,isOnReachBottom:!1,hasmore:!0,pageOnShow:!1},onLoad:function(t){wx.showLoading({title:"加载中...",mask:!0});var a=this;common.configData("learn",function(){common.commonFun(a),a.getData(0)})},getData:function(t){var a=this,e=this,i="",n=e.data.info,s=[];switch(Number(e.data.currentTab)){case 0:i="/hdh/"+getApp().globalData.acid+"/subscription/?offset="+t+"&limit="+this.state.limit+"&kind=column",s=this.data.info.zhuanlanList;break;case 1:i="/hdh/"+getApp().globalData.acid+"/subscription/?offset="+t+"&limit="+this.state.limit+"&kind=digital_content",s=this.data.danpinList}util.httpRequest(i).then(function(i){var o=common.dataListHandle(e,i,s,t);o.list.forEach(function(t){var a=new Date(t.subscription_addtime),e=a.getTime(),i=864e5*Number(t.validDays);a.setTime(e+i),t.valid_time=util.formatTime1(a)}),0===e.data.currentTab?(n.zhuanlanList=o.list,n.hasNext=o.hasNext,e.setData({info:n,requestStatus:!0})):1===a.data.currentTab&&e.setData({danpinList:o.list,requestStatus:!0,hasNext:o.hasNext})})},deleteColumnSubscribe:function(t){var a=t.currentTarget.dataset.index,e=this.data.info.zhuanlanList,i="/learn/"+e[a].id+"/cancelSubscribe/",n={types:"column"};t.id=e[a].id,t.typeid=7,t.remark="delete_zl_subscribe",common.getFormId(t),this.cancelRequest(i,n,a)},deleteDanpinSubscribe:function(t){var a=t.currentTarget.dataset.index,e=this.data.danpinList,i="/learn/"+e[a].id+"/cancelSubscribe/",n={types:"danpin"};t.id=e[a].id,t.typeid=7,t.remark="delete_dp_subscribe",common.getFormId(t),this.cancelRequest(i,n,a)},cancelRequest:function(t,a,e){var i=this;wx.showModal({title:"提示",content:i.data.iphoneShow?"是否确认取消，取消之后，如需正常查看，需要重新订阅":"是否确认取消，取消之后将不能正常预览",showCancel:!0,success:function(n){n.confirm&&(wx.showLoading({title:"处理中...",mask:!0}),util.httpRequest(t,a,"POST").then(function(t){if(wx.hideLoading(),"success"===t.result)if(getApp().globalData.learnCallback&&getApp().globalData.learnCallback(),common.showTimeToast(t.msg),"column"===a.types){var n=i.data.info;n.zhuanlanList.splice(e,1),i.setData({info:n})}else{var s=i.data.danpinList;s.splice(e,1),i.setData({danpinList:s})}else common.showClickModal(t.msg)}))}})},swichNav:function(t){var a=parseInt(t.currentTarget.dataset.current);if(this.data.currentTab!==a){this.state.offset=0,this.state.hasmore=!0,this.setData({currentTab:a,requestStatus:!1}),wx.showLoading({title:"加载中...",mask:!0});var e=this;setTimeout(function(){e.getData(0)},1e3)}},onShow:function(){var t=this;getApp().globalData.updateDanpinCallback=function(a){var e=t.data.danpinList;dpTemp.getDanpinDetail(t,e[a].target_id,a)},getApp().globalData.updateZhuanlanCallback=function(a){var e=t.data.info;dpTemp.getZhuanlanDetail(t,e.zhuanlanList[a].target_id,a)}},danpinDetail:function(t){dpTemp.openDanpinDetail(t)},getFormId:function(t){dpTemp.getFormId(t)},onPullDownRefresh:function(){wx.showLoading({title:"加载中...",mask:!0}),this.state.hasmore=!0,this.state.offset=0,this.getData(0)},onReachBottom:function(){this.state.isOnReachBottom&&this.state.hasmore&&(wx.showLoading({title:"加载中...",mask:!0}),this.state.offset=this.state.offset+this.state.limit,this.getData(this.state.offset),this.state.isOnReachBottom=!1)}});