"use strict";var common=getApp().globalData.commonFun,util=getApp().globalData.utilFun,payTempImport=getApp().globalData.payTemp,payEvent=getApp().globalData.payEvent;Page({data:{interfaceName:"myWallet",contactStatus:!0,tixian:"hide",total_money:0,value:"",hongbao:{},list:[],erweiCode:"",pageN:"myWallet",requestStatus:!1,payAndBingPhoneStatus:!1},state:{pageType:"",offset:0,limit:10,hasmore:!0,typename:"weixin",pageOnshow:!1},onLoad:function(t){wx.showLoading({title:"加载中...",mask:!0});var a=this;common.payAndBingPhoneSetData(a,function(t){a.setData({payAndBingPhoneStatus:!0})}),common.getAccessToken()?(common.commonFun(a),a.getData(0)):getApp().globalData.tokenUpdated=function(){console.log("update success"),common.commonFun(a),a.getData(0)}},onShow:function(){this.state.pageOnshow&&getApp().globalData.walletReach&&(this.state.offset=0,this.getData(0))},getData:function(t){var a=this,o="/wallet/transaction/?type=hongbao&offset="+t+"&limit="+a.state.limit;util.httpRequest(o).then(function(o){var e=common.dataListHandle(a,o,a.data.list,t);e.list&&e.list.length>0&&e.list.forEach(function(t,a){var o=e.list[a];if("withdraw"===o.type&&"paid"!==o.withdraw_status){var n=o.amount.toString().length,i=o.amount.toString();o.money=parseFloat(i.substring(1,n))}}),a.store({list:e.list,requestStatus:!0,hasNext:e.hasNext}),common.getWallet(a)})},onReachBottom:function(){this.state.hasmore&&(wx.showLoading({title:"加载中...",mask:!0}),this.state.offset=this.state.offset+this.state.limit,this.getData(this.state.offset))},onWallet:function(t){var a=t.target.dataset.walletid;this.getQrCode(a)},getQrCode:function(t){var a=this;wx.showLoading({title:"正在生成二维码",mask:!0});var o="/transaction/"+t+"/qrcode";util.httpRequest(o).then(function(t){wx.hideLoading(),a.setData({erweiCode:t.thumb_medium_url}),common.seeBigImg(1,t.original_url,"")})},payEvent:function(t){payTempImport.payChangeEvent(this,t)},money:function(t){this.store({total_money:t.detail.value})},tixian:function(){this.submit()},tixianAll:function(){this.store({total_money:this.data.hongbao.balance}),this.submit()},submit:function(){if(0===this.data.total_money||""===this.data.total_money)common.showClickModal("请输入提现金额");else{var t=this.data.total_money,a=this.data.hongbao.balance;t>this.data.hongbao.withdraw_max?common.showClickModal("单笔提现金额最多"+this.data.hongbao.withdraw_max+"元"):t<this.data.hongbao.withdraw_min?common.showClickModal("单笔提现金额最少"+this.data.hongbao.withdraw_min+"元"):t<=a?this.store({payTk:"show",Board:"show",tixian:"hide"}):common.showClickModal("余额不足")}},opentixian:function(){var t=this;common.walletInfo(this,function(a){a.has_pay_password?t.store({tixian:"show"}):wx.showModal({title:"提示",content:"您还没有设置支付密码，请前往设置",showCancel:!1,success:function(t){t.confirm&&wx.navigateTo({url:"/pages/common/pages/set/set"})}})})},walletPay:function(){var t=this;wx.showLoading({title:"提交中...",mask:!0});var a={amount:Number(t.data.total_money),paypass:t.data.passwords,type:"withdraw"};util.httpRequest("/wallet/transaction",a,"POST").then(function(a){if(wx.hideLoading(),"success"===a.result){t.store({list:[],payTk:"hide",total_money:0,value:""}),common.commonFun(t),payEvent.passwordClear(t);"paid"===a.transaction.withdraw_status?wx.navigateTo({url:"/pages/common/pages/walletFinish/walletFinish"}):wx.navigateTo({url:"/pages/common/pages/uploadPaycode/uploadPaycode"})}else common.showClickModal(a.msg)}).catch(function(t){wx.hideLoading(),common.showClickModal(t.msg)})},closetixian:function(){this.store({tixian:"hide"})},store:function(t){this.setData(t)}});