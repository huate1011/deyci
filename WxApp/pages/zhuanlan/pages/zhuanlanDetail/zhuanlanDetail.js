"use strict";var common=getApp().globalData.commonFun,util=getApp().globalData.utilFun,getPhone=getApp().globalData.phoneFun,WxParse=require("../../../../wxParse/wxParse.js"),extensionTemp=require("../../../commonPage/extension/comfunc.js"),dpTemp=require("../../../commonPage/zhuanlan/temp.js"),payTempImport=getApp().globalData.payTemp;Page({data:{interfaceName:"zhuanlanDetail",payAndBingPhoneStatus:!1,requestStatus:!1,adStatus:!0,openType:"navigateTo",currentTab:0,btnShow:!1,tgCenter:{fangShi:"hide"},danpingRequest:!1,convertible:!0,coupon:"",payId:0,useCode:!1,codeVal:"",isFixed:!1,giveNum:1,givePayMoney:0,showGive:!1,giveAlert:[!1,!1],isGift:!1,nbPhone:!0,phone:"",bindPhone:!1,btnPhoneNumber:!1},tabOffsetTop:null,state:{zhuanlanId:"",offset:0,limit:10,hasmore:!0,isOnReachBottom:!1,pageOnShow:!1,options:{}},store:function(t){this.setData(t)},onLoad:function(t){console.log(t);var e=decodeURIComponent(t.scene);console.log(e);var a={};if("undefined"!==e){var n=e.split("#");a={zhuanlanId:n[0],uid:n[1]}}else a=t;console.log(a),this.state.options=a,this.state.learnId=a.zhuanlanId,wx.showLoading({title:"加载中...",mask:!0});var i=this;common.payAndBingPhoneSetData(i,function(t){i.setData({payAndBingPhoneStatus:!0})}),common.configData("learn",function(){common.getAccessToken()?(i.zhuanlanDetail(a.zhuanlanId,!0),common.commonFun(i),common.getWallet(i)):getApp().globalData.tokenUpdated=function(){console.log("update success"),i.zhuanlanDetail(a.zhuanlanId,!0),common.commonFun(i),common.getWallet(i)}})},onShow:function(){var t=this;getApp().globalData.updateDanpinCallback=function(e){var a=t.data.danpinList;dpTemp.getDanpinDetail(t,a[e].id,e)},this.state.pageOnShow&&this.zhuanlanDetail(this.data.detail.id,!1)},onUnload:function(){var t=this.state.options,e=this.data.detail;t.hasOwnProperty("index")&&getApp().globalData.updateZhuanlanCallback&&getApp().globalData.updateZhuanlanCallback(t.index),t.hasOwnProperty("collectIndex")&&!e.isCollect&&getApp().globalData.updateCollectList&&getApp().globalData.updateCollectList(t.collectIndex)},collect:function(t){var e=this.data.detail;t.id=e.id,t.typeid=7,t.remark="column_collect",common.getFormId(t),t.typeName="column",t.types=e.isCollect?"cancel":"collect";var a=this;common.collect(t,function(t){a.zhuanlanDetail(e.id,!1)})},zhuanlanDetail:function(t,e){common.shareLog(this,13,t);var a=this,n="/column/detail/"+t+"/";util.httpRequest(n).then(function(t){if("success"===t.result){var n=t.results;a.state.productId=n.sales_product_id,wx.setNavigationBarTitle({title:n.title});var i=n.fee;n.isMemberLearn&&n.member.isMember&&(i=n.fee_member),a.store({detail:n,total_money:i,givePayMoney:i,nbPhone:1===Number(n.config.nbPhone),tgDataDetail:n.productDetail,requestStatus:!0}),e&&wx.pro.fromSync(function(t){if(n.info){var e=WxParse.wxParse("article","html",n.info,a,5);a.store(e)}}),a.state.pageOnShow=!0,(Number(n.fee)>0||n.has_bought)&&a.contentList(0),extensionTemp.tuiguangInfo(a),common.updateTabOffsetTop(a)}else common.showClickModal(t.msg);wx.hideLoading()})},contentList:function(t){var e=this,a="/column/"+this.data.detail.id+"/digitalcontent/?offset="+t+"&limit="+this.state.limit;util.httpRequest(a).then(function(a){wx.hideLoading();var n=e.data.danpinList;a.count>0?n=0===t?a.results:n.concat(a.results):0===t&&(n=[]),console.log("count:"+a.count+";next:"+a.next),0===a.next?e.state.hasmore=!1:e.state.hasmore=!0,e.state.isOnReachBottom=!0,e.store({danpinList:n,danpingRequest:!0})})},danpinDetail:function(t){if("normal"!==this.data.detail.status)return void common.showClickModal("专栏已下架，不能观看！");var e=this.data.danpinList,a=t.currentTarget.dataset.index;if(!e[a].is_preview&&!e[a].has_bought)return void common.showClickModal("订阅专栏后才能观看！");dpTemp.openDanpinDetail(t)},buyZhuanlan:function(t){t.id=this.data.detail.id,t.typeid=7,t.remark="column_subscribe",common.getFormId(t);var e=this,a=this.data.tgDataDetail,n=this.data.tankuang;if(!e.data.bindPhone&&e.data.nbPhone)return void wx.showModal({title:"提示",content:"您还未绑定手机号，请先绑定",showCancel:!0,success:function(t){t.confirm&&(n[3]="show",e.store({tankuang:n}))}});if(t.currentTarget.dataset.types||(t.currentTarget.dataset.types=t.types,t.detail.value=""),a.skus){"free"===this.data.detail.fee_type?payTempImport.payChangeEvent(this,t):("show"===n[3]&&(n[3]="hide",this.data.CountdownVal[2]="发送验证码",this.data.CountdownTime[2]=60,this.data.onClick[2]=!0),this.store({tankuang:n,CountdownVal:this.data.CountdownVal,CountdownTime:this.data.CountdownTime,onClick:this.data.onClick,showPayMethod:!0}))}this.getFormId(t,"zhuanlan")},onReachBottom:function(){if(0!==parseInt(this.state.currentTab)&&this.state.isOnReachBottom&&this.state.hasmore){wx.showLoading({title:"加载中...",mask:!0});var t=this.state.offset;t+=this.state.limit,this.contentList(t),this.state.offset=t,this.state.isOnReachBottom=!1}},swichNav:function(t){var e=parseInt(t.currentTarget.dataset.current);this.data.currentTab!==e&&this.store({currentTab:t.currentTarget.dataset.current})},onShareAppMessage:function(t){var e=this,a=this.data.detail.id;extensionTemp.tkHide(this);var n="pages/zhuanlan/pages/zhuanlanDetail/zhuanlanDetail?formType=1&zhuanlanId="+a;return n+="&uid="+this.data.myInfo.id,console.log(n),{title:e.data.detail.subject,path:n}},giveFriends:function(t){var e=this.data.detail;t.id=e.id,t.typeid=7,t.remark="column_give",common.getFormId(t),this.data.giveAlert[0]=!0,this.store({showGive:!0,isGift:!0,giveNum:1,giveAlert:this.data.giveAlert,givePayMoney:e.fee})},seeGiveProduct:function(t){t.id=this.data.detail.id,t.typeid=7,t.remark="column_give",common.getFormId(t),this.data.giveAlert[0]=!1,this.data.giveAlert[1]=!0,this.store({giveAlert:this.data.giveAlert})},giveChangeVal:function(t){var e=this.data.giveNum,a=this.data.detail;e=common.isNull(t.detail.value)?1:Number(t.detail.value),this.store({giveNum:e,givePayMoney:(e*a.fee).toFixed(2)})},downGiveNum:function(t){var e=this.data.detail;t.id=e.id,t.typeid=7,t.remark="column_give",common.getFormId(t);var a=this.data.giveNum;a>1&&(a-=1,this.store({giveNum:a,givePayMoney:(a*e.fee).toFixed(2)}))},addGiveNum:function(t){var e=this.data.detail;t.id=e.id,t.typeid=7,t.remark="column_give",common.getFormId(t);var a=this.data.giveNum;a+=1,this.store({giveNum:a,givePayMoney:(a*e.fee).toFixed(2)})},sureGivePay:function(t){var e=this.data.detail;if(t.id=e.id,t.typeid=7,t.remark="column_give",common.getFormId(t),this.data.givePayMoney>0&&!this.data.iphoneShow)return void common.showClickModal("当前小程序暂不支持该功能");this.data.giveAlert[1]=!1;var a=this.data.givePayMoney,n=this.data.showPayMethod;this.data.bindPhone&&(n=!0),this.store({showGive:!1,giveAlert:this.data.giveAlert,showPayMethod:n,convertible:!1,total_money:a}),this.state.giveFriends=!0,this.buyZhuanlan(t)},onPageScroll:function(t){common.goTopEvent(this,t.scrollTop),common.scrollIsTabFixed(this,t)},onBackTop:function(){common.isscrollToPage(this)},onUseCode:function(){dpTemp.onUseCode(this)},changeVal:function(t){dpTemp.changeVal(t,this)},closeGive:function(){this.setData({showGive:!1,giveAlert:[!1,!1]})},getFormId:function(t,e){var a=this,n="/product/"+a.data.detail.fee_product_id+"/log/",i={wx_form_id:t.detail.formId,action:"view",sourceType:"learn"};return e||a.danpinDetail(t),util.httpRequest(n,i,"POST").then(function(t){})},bindPhoneNumber:function(t){t.pageName="zhuanlan",getPhone.phoneChange(this,t)},importCoupon:function(t){if(!this.data.codeVal||""===this.data.codeVal)return void common.showClickModal("请输入兑换码");payTempImport.payChangeEvent(this,t)},payEvent:function(t){payTempImport.payChangeEvent(this,t);var e=t.currentTarget.dataset.types;if("closePayTypeTk"===e||"closeBaoMing"===e){var a=this.data.detail,n=a.fee;a.isMemberLearn&&a.member.isMember&&(n=a.fee_member),this.store({total_money:n,givePayMoney:n})}},callPayment:function(t,e,a,n){wx.showLoading({title:"",mask:!0});var i="/column/"+t.data.detail.id+"/payment/",o={wx_form_id:a,types:"column",product_id:t.data.detail.fee_product_id,platform:e,count:1};n&&(o.coupon_id=n),t.data.isGift&&(o.from="gift",o.count=t.data.giveNum),payTempImport.payment(t,i,o,function(e,a){t.resultEvent(t,e,a)})},walletPay:function(t){payTempImport.payRequest(t,function(e){t.resultEvent(t,e.result,e.msg)})},resultEvent:function(t,e,a){if(wx.hideLoading(),"free"===t.data.detail.fee_type)return void t.shuaXin();if("success"===e)wx.showModal({title:"提示",content:t.data.isGift?"购买成功":"操作成功",showCancel:!1,success:function(){common.getAlter(t,"paypop",function(a,n){"show"===n?t.setData({alter:a,alterHidden:e}):t.shuaXin()})}});else{common.showClickModal(a);var n=t.data.detail,i=n.fee;n.isMemberLearn&&n.member.isMember&&(i=n.fee_member),t.store({total_money:i,givePayMoney:i})}},shopListEvent:function(t){var e=t.currentTarget.dataset;e.name="payAlter",common.openUrl(e,this),"ggHide"===e.types&&this.shuaXin()},shuaXin:function(){this.data.isGift?(this.setData({isGift:!1}),wx.navigateTo({url:"/pages/zhuanlan/pages/myGift/myGift"})):this.zhuanlanDetail(this.data.detail.id,!1)},bindPhoneEvent:function(t){dpTemp.bindPhoneEvent(this,t)}});