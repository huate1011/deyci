"use strict";var util=getApp().globalData.utilFun,common=getApp().globalData.commonFun,inputChange=getApp().globalData.inputFun;Page({data:{requestStatus:!1,currentId:-1,modalTk:"show",showStatus:"show",showHbTk:"hide",infoTk:"hide",progress:0,laveTime:0,currentNum:0,currentAnSwer:"",lists:[]},state:{time:"",resultAnswer:[],inputVal:[]},onLoad:function(e){wx.setNavigationBarColor({frontColor:"#ffffff",backgroundColor:"#35246b"}),this.state.options=e,this.startAnswer(e.id)},onShow:function(){var e=this,t=common.getStorage("userInfo");this.store({myInfo:t}),getApp().globalData.answerUpdateCallback=function(t){e.state.resultAnswer=[],e.state.inputVal=[],clearInterval(e.state.time),e.setData({requestStatus:!1,currentId:-1,modalTk:"show",showStatus:"show",currentNum:0}),e.startAnswer(t)}},onShareAppMessage:function(e){var t=this,s=t.data.answerData;if("button"===e.from){util.httpRequest("/answer/partNum/get",{activeId:t.state.options.id},"GET","v2").then(function(e){console.log(e)})}return{title:s.name,path:"/pages/answer/pages/index/index",imageUrl:s.rankListImg?s.rankListImg.thumb_medium_url:"",success:function(e){wx.navigateBack({delta:1})}}},store:function(e){this.setData(e)},startAnswer:function(e){var t=this,s=t.state.resultAnswer;util.httpRequest("/answer/Attend/subject",{activeId:e},"GET","v2").then(function(e){if("success"==e.result){0==e.results.status&&wx.showModal({title:"提示",content:e.msg,showCancel:!1,success:function(){wx.navigateBack({})}});var r=(t.data.currentNum+1)/e.results.subNum*100,a=e.results.subject[0];if(1==a.choice){var n=a.questionAnswer.split(",");a.answers.forEach(function(e){e.checked=!1,e.correct=!1;for(var t=0;t<n.length;t++)n[t]==e.key&&(e.correct=!0)})}e.results.subject.forEach(function(e){var t={id:e.id,answer:""};s.push(t)}),t.store({requestStatus:!0,answerData:e.results,laveTime:e.results.AnsTimes,currentAnSwer:a,progress:r})}else wx.showModal({title:"提示",content:e.msg,showCancel:!1,success:function(e){wx.navigateBack({delta:1})}})})},getUserInfo:function(){var e=this;util.httpRequest("/answer/Attend/user",{activeId:e.state.options.id},"GET","v2").then(function(t){"success"==t.result?0==t.results.status?(e.store({modalTk:"show",infoTk:"show",lists:t.results.inputs}),inputChange.inputData(e,t.results.inputs)):e.testResult():common.showClickModal(t.msg),wx.hideLoading()})},testResult:function(){var e=this,t=e.data.answerData,s=t.AnsTimes-e.data.laveTime,r={activeId:t.id,answer:e.state.resultAnswer,times:s};wx.showLoading({title:"数据提交中...",mask:!0}),util.httpRequest("/answer/Attend/grade",r,"POST","v2").then(function(s){if("success"==s.result){var r=s.results;0==t.typeId?wx.redirectTo({url:"/pages/answer/pages/result/result?id="+r.id+"&uid="+r.current.uid+"&activeId="+t.id+"&partNum="+r.partNum+"&typeId="+t.typeId}):1==t.typeId?(common.setStorage("setConfig",r.setConfig),wx.navigateTo({url:"/pages/answer/pages/end/end?id="+t.id+"&status="+r.status})):2==t.typeId&&e.store({modalTk:"show",showHbTk:"show",redDetail:r})}else common.showClickModal(s.msg);wx.hideLoading()})},selectAnswer:function(e){var t=this,s=this.state.resultAnswer,r=e.currentTarget.dataset.index,a=this.data.currentId,n=this.data.currentNum,i=this.data.answerData,o=this.data.currentAnSwer;if(a!=r&&(0!=o.choice||-1==a)){if(1==o.choice){var c=o.questionAnswer.split(",").length,u=!1,d=0;if(o.answers.forEach(function(e){e.correct&&e.checked&&(d+=1),e.checked&&!e.correct&&(u=!0)}),u||c==d)return}if(0==o.choice)if(s[n].answer=o.answers[r].key,n<i.subNum-1){if(this.store({currentId:r}),0==i.correct&&2==i.typeId&&o.answers[r].key!=o.questionAnswer)return clearInterval(t.state.time),void setTimeout(function(){t.testResult()},300);setTimeout(function(){if(n+=1,o=i.subject[n],1==o.choice){var e=o.questionAnswer.split(",");o.answers.forEach(function(t){t.checked=!1,t.correct=!1;for(var s=0;s<e.length;s++)e[s]==t.key&&(t.correct=!0)})}t.store({currentId:-1,currentNum:n,currentAnSwer:o,progress:(n+1)/i.subNum*100})},1e3)}else clearInterval(t.state.time),this.store({currentId:r}),setTimeout(function(){wx.showLoading({title:"提交中...",mask:!0}),0==i.typeId?t.getUserInfo():(wx.hideLoading(),t.testResult())},1e3);else if(n<i.subNum-1){var l=0;if(o.answers.forEach(function(e,t){r==t&&(e.checked=!0),e.correct&&e.checked&&(l+=1)}),0==i.correct&&2==i.typeId&&o.answers[r].checked&&!o.answers[r].correct)return clearInterval(t.state.time),void setTimeout(function(){t.testResult()},300);t.store({currentAnSwer:o,currentId:r});var h=o.questionAnswer.split(",").length;if(!o.answers[r].correct||l==h){var w="";o.answers.forEach(function(e){e.checked&&(w+=""==w?e.key:","+e.key)}),s[n].answer=w,setTimeout(function(){if(n+=1,o=i.subject[n],1==o.choice){var e=o.questionAnswer.split(",");o.answers.forEach(function(t){t.checked=!1,t.correct=!1;for(var s=0;s<e.length;s++)e[s]==t.key&&(t.correct=!0)})}t.store({currentId:-1,currentNum:n,currentAnSwer:o,progress:(n+1)/i.subNum*100})},1e3)}}else{clearInterval(t.state.time);var f=0;o.answers.forEach(function(e,t){r==t&&(e.checked=!0),e.correct&&e.checked&&(f+=1)}),this.store({currentAnSwer:o,currentId:r});var m=o.questionAnswer.split(",").length;if(!o.answers[r].correct||f==m){var g="";o.answers.forEach(function(e){e.checked&&(g+=""==g?e.key:","+e.key)}),s[n].answer=g,setTimeout(function(){wx.showLoading({title:"提交中...",mask:!0}),0==i.typeId?t.getUserInfo():t.testResult()},1e3)}}}},closeTk:function(e){var t=this;"start"==e.currentTarget.dataset.types?(this.state.time=setInterval(function(){var e=t.data.laveTime-1;t.store({laveTime:e}),e<=0&&(clearInterval(t.state.time),wx.showLoading({title:"提交中...",mask:!0}),0==t.data.answerData.typeId?t.getUserInfo():t.testResult())},1e3),this.store({showStatus:"hide",modalTk:"hide"})):(this.store({showHbTk:"hide",modalTk:"hide"}),wx.navigateBack({delta:1}))},answerEven:function(e){var t=e.currentTarget.dataset,s=this.data.answerData;if("begain"==t.types){0==this.data.redDetail.partNum?common.showClickModal("您已没有机会了，快去领取复活卡吧"):wx.redirectTo({url:"/pages/answer/pages/answer/answer?id="+s.id+"&typeId="+s.typeId})}else"record"==t.types&&wx.redirectTo({url:"/pages/answer/pages/leaderboard/leaderboard?id="+s.id+"&typeId="+s.typeId})},inputEvent:function(e){inputChange.eventChange(this,e)},submitInfo:function(e){console.log(e);var t=this,s=(e.detail.value,t.state.inputVal);inputChange.contentJudge(t,function(e){var r={activeId:t.state.options.id,inputs:s};wx.showLoading({title:"提交中...",mask:!0}),util.httpRequest("/answer/Attend/userSave",r,"POST","v2").then(function(e){"success"==e.result?(t.store({modalTk:"hide",infoTk:"hide"}),t.testResult()):common.showClickModal(e.msg)})})}});