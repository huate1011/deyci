"use strict";var common=getApp().globalData.commonFun,util=getApp().globalData.utilFun,getPhone=getApp().globalData.phoneFun;Page({data:{contactStatus:!0,showid:5,num:0,showView:!1,member:[],winList:[],award:"",showtk:!1,isWin:!1,nbPhone:!0,phone:"",CountdownVal:["发送验证码","发送验证码","发送验证码","发送验证码"],tankuang:["hide","hide","hide","hide"],CountdownTime:[60,60,60,60],onClick:[!0,!0,!0,!0],bindPhone:!1,clearTimeout:!0,btnPhoneNumber:!1},state:{offset:0,limit:10,hasmore:!0,isOnReachBottom:!0,onOff:!1},getLotterys:function(){common.commonFun(this);var t=this,e=common.getStorage("userInfo").id,s="/getLotterys?id="+t.state.lid+"&uid="+e;util.httpRequest(s,{},"GET","v2").then(function(e){wx.hideLoading(),"success"===e.result?t.store({details:e,member:e.data.member,num:e.data.datanum}):common.showClickModal(e.msg)})},separate:function(t){var e=this,s=common.getStorage("userInfo").id,o=common.getStorage("userInfo").phone,a=e.data.num;if(!o)return void wx.showModal({title:"提示",content:"请先绑定手机号！",showCancel:!1,success:function(){var t=e.data.tankuang;t[3]="show",e.store({tankuang:t})}});if(!e.state.onOff)if(e.state.onOff=!0,Number(a)>0){var i=t.currentTarget.id,n={id:Number(e.state.lid),uid:s};util.httpRequest("/goDraw/",n,"POST","v2").then(function(t){if("success"===t.result){e.setData({showid:i,message:t.msg});var s=2;a-=1,e.getlist(0,"all",!0);var o=setInterval(function(){if(s-=1,0===Number(s)){var i="",n=!1;t.product&&(i=t.product,n=!0),clearInterval(o),e.store({award:i,isWin:n,showView:!e.data.showView,num:a}),e.state.onOff=!1}},1e3)}else wx.showModal({title:"提示",content:t.msg,showCancel:!1,success:function(){e.store({showid:5}),e.state.onOff=!1}})})}else e.state.onOff=!1,wx.showModal({title:"提示",content:"今日抽奖次数已用完！",showCancel:!1,success:function(t){t&&e.setData({showid:5})}})},getlist:function(t,e,s){var o=this,a=o.data.details,i="/winlist/?offset="+t+"&limit="+o.state.limit+"&lid="+a.data.id;"all"===e&&(i="/winlist/?offset="+t+"&limit="+o.state.limit+"&lid="+a.data.id+"&alluser=1"),util.httpRequest(i,{},"GET","v2").then(function(a){if(s)return void o.store({member:a.results});if(0===a.count)return void common.showClickModal("暂无中奖纪录！");var i=common.dataListHandle(o,a,o.data.winlist,t);o.store({prizeNum:a.count,winlist:i.list,showtk:!0,showType:e})})},showgo:function(){this.setData({showView:!this.data.showView,showid:5})},onLoad:function(t){var e=this;wx.showLoading({title:"加载中...",mask:!0}),e.state.lid=t.id,common.getAccessToken()?e.getLotterys():getApp().globalData.tokenUpdated=function(){console.log("update success"),e.getLotterys()}},moreModel:function(t){var e=t.currentTarget.dataset.types;this.state.offset=0,this.getlist(0,e)},lower:function(t){this.state.isOnReachBottom&&this.state.hasmore&&(this.state.offset=this.state.offset+this.state.limit,this.getlist(this.state.offset,this.data.showType),this.state.isOnReachBottom=!1)},store:function(t){this.setData(t)},close:function(t){var e=t.currentTarget.dataset.index;if(e){var s=this.data.tankuang;s[e]="hide",this.store({tankuang:s})}else this.store({showtk:!1})},onShareAppMessage:function(){return{title:"幸运砸金蛋",path:"/pages/market/eggs/eggs/index?id="+this.state.lid}},bindPhoneNumber:function(t){t.pageName="market",getPhone.phoneChange(this,t)}});