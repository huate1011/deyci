"use strict";function listData(t,a,e){a+="&istitle="+common.getStorage("config").catalog.isTitle,util.httpRequest(a).then(function(a){var i=common.dataListHandle(t,a,t.data.list,e);i.list.forEach(function(t,a){i.list[a].uid=common.getStorage("userInfo").id,t.hasOwnProperty("content")&&(t.content.length>100?i.list[a].isMore=!0:i.list[a].isMore=!1)}),t.setData({list:i.list,requestStatus:!0,hasNext:i.hasNext}),wx.hideLoading(),wx.stopPullDownRefresh()})}function getDataUrl(t,a,e){var i="";return 0===Number(e)&&(i="/hdh/"+getApp().globalData.acid+"/catalogthread/?filter=all&limit="+t.state.limit+"&offset="+a),1===Number(e)&&(i="/hdh/"+getApp().globalData.acid+"/catalogthread/?filter=all&order=nearby&limit="+t.state.limit+"&offset="+a),2===Number(e)&&(i="/hdh/"+getApp().globalData.acid+"/catalogthread/?filter=me&order=recent&limit="+t.state.limit+"&offset="+a),i}function listDataFirst(t,a,e){listData(t,getDataUrl(t,a,e),a)}function getCatalogType(t){var a="/hdh/"+getApp().globalData.acid+"/catalogp/?offset=0&limit=100";util.httpRequest(a).then(function(a){var e=[],i=[];a.results.forEach(function(t,s){i.push(t),8!==i.length&&s!==a.results.length-1||(e.push(i),i=[])});var s=common.getStorage("config").catalog;if(t.store({typeName:e,bulletinTxt:s.bulletinTxt,navRequestStatus:!0}),s.bulletinTxt){wx.getSystemInfoSync().windowWidth;wx.createSelectorQuery().select("#txt1").boundingClientRect(function(a){if(a&&a.hasOwnProperty("width")){var e=.04*a.width;console.log(e),t.setData({duration:e})}}).exec()}})}function sameCityCount(t){var a="catalog/"+getApp().globalData.acid+"/count/";util.httpRequest(a).then(function(a){t.store({sameCityStat:a})})}function config(t){dataTemp.getBanner(t,"catalog"),t.sameCityEvent=sameCityEvent,common.configData("catalog",function(){common.commonFun(t);var a=common.getStorage("config").catalog;a.module?(1===Number(a.isTitle)?t.state.limit=20:t.state.limit=5,listDataFirst(t,0,t.data.currentTab),1===Number(a.isStat)&&sameCityCount(t),getCatalogType(t)):common.showClickModal(a.msg)})}function switchNav(t,a){var e=t.data.currentTab;Number(e)!==Number(a)&&(wx.showLoading({title:"加载中...",mask:!0}),t.setData({currentTab:Number(a),list:[],requestStatus:!1}),t.state.offset=0,t.state.isOnReachBottom=!1,1===Number(a)?common.currentLocation(0,function(e){t.state.lat=e.latitude,t.state.lng=e.longitude,common.setStorage("position",{lat:e.latitude,lng:e.longitude}),listDataFirst(t,0,a)}):listDataFirst(t,0,a))}function deletePub(t,a,e,i){var s="/catalogthread/"+a+"/delete/";util.httpRequest(s,{},"PUT").then(function(a){wx.showModal({title:"提示",content:"删除成功",showCancel:!1,success:function(a){var e=t.state.options;e.hasOwnProperty("index")&&getApp().globalData.sameCityDeleteCallback(e.index),wx.navigateBack({})}})}).catch(function(t){wx.showModal({title:"提示",content:t.msg,showCancel:!1,success:function(t){}})})}function showActionSheetEvent(t,a,e){var i=t.data.myInfo.id;if(Number(a.uid)===Number(i)||t.data.detail.is_admin){var s=["删除","编辑","置顶"];t.data.detail.catalog.name||(s=["删除"]),t.data.detail.is_top&&(s=["删除","编辑"],t.data.detail.catalog.name||(s=["删除"])),wx.showActionSheet({itemList:s,success:function(i){if(0===Number(i.tapIndex))deletePub(t,a.id,e,a.index);else if(1===Number(i.tapIndex))wx.navigateTo({url:"/pages/sameCity/pages/publish/publish?detailId="+t.data.detail.id+"&id="+t.data.detail.catalog.id+"&delta=1"});else if(2===Number(i.tapIndex)){var s=t.data.detail;wx.navigateTo({url:"/pages/sameCity/pages/zhiDing/zhiDing?delta=1&id="+s.id+"&catalogid="+s.catalog.id})}}})}else wx.showActionSheet({itemList:["举报"],success:function(t){0===Number(t.tapIndex)&&wx.navigateTo({url:"/pages/sameCity/pages/report/report?delta=1&id="+a.id})}})}function tcDetail(t,a,e){var i=t.data.list;if(i[e]){var s="/catalogthread/"+a+"/";util.httpRequest(s).then(function(a){i[e].content=a.content,i[e].view_count=a.view_count,i[e].comment_count=a.comment_count,i[e].is_like=a.is_like,i[e].like_count=a.like_count,i[e].is_top=a.is_top,i[e].title=a.title,i[e].attachments=a.attachments,t.setData({list:i})})}}function dianzanPub(t,a,e,i,s){var o=t.data.list;if("list"===e&&"normal"!==o[s].status)return void common.showClickModal("该状态无法操作！");wx.showLoading({title:"",mask:!0}),common.wxAuthorize(t,function(o){if(o){var n="";n=0===Number(a)?"/catalogthread/"+i+"/like/delete/":"/catalogthread/"+i+"/like/",util.httpRequest(n,{},"PUT").then(function(a){wx.hideLoading(),"success"===a.result?"list"===e?tcDetail(t,i,s):t.sameCityDetail(i):common.showClickModal(a.msg)})}})}function typeListData(t,a){t.sameCityEvent=sameCityEvent,common.configData("catalog",function(){common.commonFun(t);var e=common.getStorage("config").catalog;if(e.module){var i="/hdh/"+getApp().globalData.acid+"/catalog/?offset=0&limit=100";util.httpRequest(i).then(function(e){var i=common.dataListHandle(t,e,t.data.list,a);t.setData({list:i.list,requestStatus:!0,config:common.getStorage("config")}),wx.hideLoading()})}else common.showClickModal(e.msg)})}function listShare(t,a){"normal"!==t.data.list[a.index].status&&common.showClickModal("该状态无法操作！")}function showMoreData(t,a){var e=t.data.list;e[a.index].isMore=!1,t.setData({list:e})}function hideMoreData(t,a){var e=t.data.list;e[a.index].isMore=!0,t.setData({list:e})}function sameCityEvent(t){var a=this,e=t.currentTarget.dataset;if("switchNav"===e.types)switchNav(a,e.current);else if("zhiding"===e.types)wx.navigateTo({url:"/pages/sameCity/pages/zhiDing/zhiDing?delta=1&id="+e.id+"&catalogid="+e.catalogid});else if("search"===e.types){var i=[{name:"search",data:{placeholder:"搜索",type:"catalog"}}];common.setStorage("layout",i),wx.navigateTo({url:"/pages/common/pages/search/search"})}else if("call"===e.types)common.phoneCall(e.phone);else if("event"===e.types)showActionSheetEvent(a,e,"list");else if("dianzan"===e.types)dianzanPub(a,e.status,"list",e.pubid,e.index);else if("share"===e.types)listShare(a,e);else if("detail"===e.types)wx.navigateTo({url:"/pages/sameCity/pages/detail/detail?id="+e.id+"&index="+e.index});else if("bigImg"===e.types){var s=a.data.list[e.index].attachments,o=e.url;common.seeBigImg(2,o,s)}else if("address"===e.types)common.openMap(e.lat,e.lng);else if("publish"===e.types)wx.navigateTo({url:"/pages/sameCity/pages/classify/classify"});else if("onBackTop"===e.types)common.isscrollToPage(a);else if("openWindow"===e.types)common.openUrl(e,a);else if("liexing"===e.types)wx.navigateTo({url:"/pages/sameCity/pages/list/list?id="+e.id+"&typesid="+e.typesid});else if("zhankaiMore"===e.types)showMoreData(a,e);else if("yincangMore"===e.types)hideMoreData(a,e);else if("openPub"===e.types){var n=a.data.list;n[e.index].sub_catalogs.length>0?wx.navigateTo({url:"/pages/sameCity/pages/classify2/classify2?id="+n[e.index].id}):wx.navigateTo({url:"/pages/sameCity/pages/publish/publish?delta=2&id="+n[e.index].id})}}function implementShow(t){getApp().globalData.sameCityCallback=function(){config(t),t.state.offset=0},getApp().globalData.sameCityUpdateCallback=function(a){var e=t.data.list;tcDetail(t,e[a].id,a)},getApp().globalData.sameCityDeleteCallback=function(a){var e=t.data.list;e.splice(a,1),t.setData({list:e})},getApp().globalData.sameCityPublishCallback=function(a){t.state.offset=0,t.setData({list:[],currentTab:a,requestStatus:!1}),listDataFirst(t,0,a),common.isscrollToPage(t)}}function detailSameCityEvent(t){t.sameCityEvent=sameCityEvent}var common=getApp().globalData.commonFun,dataTemp=getApp().globalData.dataTempFun,util=getApp().globalData.utilFun;module.exports={config:config,sameCityCount:sameCityCount,sameCityEvent:sameCityEvent,listDataFirst:listDataFirst,tcDetail:tcDetail,listData:listData,showActionSheetEvent:showActionSheetEvent,implementShow:implementShow,dianzanPub:dianzanPub,typeListData:typeListData,detailSameCityEvent:detailSameCityEvent};