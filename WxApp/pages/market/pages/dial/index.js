"use strict";var common=getApp().globalData.commonFun,util=getApp().globalData.utilFun,getPhone=getApp().globalData.phoneFun;Page({data:{circleList:!0,contactStatus:!0,colorCircleFirst:"https://www.haojian.cn/wximg/market/lamplight.png",colorCircleSecond:"https://www.haojian.cn/wximg/market/lamplight2.png",num:0,showRotate:!1,showro:0,rotaes:"",member:[],awards:[],showtk:!1,winlist:[],isMinning:!1,showPrize:!1,prizeInfo:"",nbPhone:!0,phone:"",CountdownVal:["发送验证码","发送验证码","发送验证码","发送验证码"],tankuang:["hide","hide","hide","hide"],CountdownTime:[60,60,60,60],onClick:[!0,!0,!0,!0],bindPhone:!1,clearTimeout:!0,btnPhoneNumber:!1},state:{offset:0,limit:10,hasmore:!0,isOnReachBottom:!0,onoff:!1},bindPointer:function(){var t=this;if(!common.getStorage("userInfo").phone)return void wx.showModal({title:"提示",content:"请先绑定手机号！",showCancel:!1,success:function(){var e=t.data.tankuang;e[3]="show",t.store({tankuang:e})}});if(!t.state.onoff)if(t.data.num>=1){var e={uid:common.getStorage("userInfo").id,id:Number(t.state.lid)},a=t.data.num;util.httpRequest("/goDraw/",e,"POST","v2").then(function(e){if(wx.hideLoading(),"success"===e.result){t.state.onoff=!0,a-=1;var s=3,i=void 0;if(e.product){t.data.awards.forEach(function(t,a){Number(t.id)===Number(e.product.id)&&(i=a)});var o=1458-36*i-parseInt(36*Math.random());t.setData({showRotate:!0,showro:o,num:a}),t.state.times=setInterval(function(){t.setData({circleList:!t.data.circleList})},200),t.state.timer=setInterval(function(){s-=1,0===Number(s)&&(t.getlist(0,"all",!0),t.state.onoff=!1,t.store({isMinning:!0,showtk:!0,prizeInfo:e}))},1e3)}else{t.data.awards.forEach(function(t,a){t.id&&!e.product&&(i=a+1)});var n=1458-36*i-parseInt(36*Math.random());t.setData({showRotate:!0,showro:n,num:a}),t.state.times=setInterval(function(){t.setData({circleList:!t.data.circleList})},200),t.state.timer2=setInterval(function(){s-=1,0===Number(s)&&(t.state.onoff=!1,t.store({isMinning:!1,showtk:!0,prizeInfo:e}))},1e3)}}else common.showClickModal(e.msg)})}else wx.showModal({title:"提示",content:"今日抽奖次数已用完！",showCancel:!1,success:function(e){t.setData({showRotate:!1})}})},onLoad:function(t){var e=this;e.state.lid=t.id,wx.showLoading({title:"加载中...",mask:!0}),common.getAccessToken()?e.getLotterys():getApp().globalData.tokenUpdated=function(){console.log("update success"),e.getLotterys()}},getLotterys:function(){common.commonFun(this);var t=this,e="/getLotterys?id="+t.state.lid;util.httpRequest(e,{},"GET","v2").then(function(e){if(wx.hideLoading(),"success"===e.result){for(var a=[],s=0;s<10;s+=1){var i={code:s,name:"谢谢参与"};a.push(i)}var o=e.data.product,n=0,r=0;a.forEach(function(t,e){e===n&&r<o.length&&(a.splice(e,1,o[r]),n+=Math.floor((10-e)/(o.length-r)),r+=1)});for(var l=36*o.length,h=0;h<a.length;h+=1)a[h].rotates=36*h,a[h].nowName=a[h].name.split("，")[0];t.store({details:e.data,member:e.data.member,awards:a,rotaes:l,num:e.data.datanum})}else common.showClickModal(e.msg)})},getlist:function(t,e,a){this.state.times&&clearInterval(this.state.times);var s=this,i=s.data.details,o="/winlist/?offset="+t+"&limit="+s.state.limit+"&lid="+i.id;"all"===e&&(o="/winlist/?offset="+t+"&limit="+s.state.limit+"&lid="+i.id+"&alluser=1"),util.httpRequest(o,{},"GET","v2").then(function(i){if(a)return void s.store({member:i.results});if(0===Number(i.count))return void common.showClickModal("暂无中奖纪录！");var o=common.dataListHandle(s,i,s.data.winlist,t);s.store({prizeNum:i.count,winlist:o.list,showtk:!0,showPrize:!0,showType:e})})},moreModel:function(t){var e=t.currentTarget.dataset.types;this.state.offset=0,this.getlist(0,e)},lower:function(t){this.state.isOnReachBottom&&this.state.hasmore&&(this.state.offset=this.state.offset+this.state.limit,this.getlist(this.state.offset,this.data.showType),this.state.isOnReachBottom=!1)},onShareAppMessage:function(){return{title:"欢乐大转盘",path:"/pages/market/pages/dial/index?id="+this.state.lid}},store:function(t){this.setData(t)},close:function(t){var e=t.currentTarget.dataset,a=e.index;if(a){var s=this.data.tankuang;s[a]="hide",this.store({tankuang:s})}else this.store({showtk:!1,showPrize:!1,isMinning:!1,showRotate:!1}),this.state.timer&&clearInterval(this.state.timer),this.state.timer2&&clearInterval(this.state.timer2),this.state.times&&clearInterval(this.state.times),"again"===e.types&&this.bindPointer()},bindPhoneNumber:function(t){t.pageName="market",getPhone.phoneChange(this,t)}});