"use strict";var common=getApp().globalData.commonFun,util=getApp().globalData.utilFun;Page({data:{alterHidden:"hide",commentInfo:"",placeholderVal:"输入回复内容...",isFocus:!1,contentVal:"",replyInfo:[],interfaceName:"commonList",list:{},requestStatus:!1,messageDetail:"hide",scrolltop:0,comments:[],detail:{}},state:{offset:0,limit:20,hasmore:!0,productType:"",isOnReachBottom:!1,activityId:"",count:0},onLoad:function(t){if(wx.showLoading({title:"加载中...",mask:!0}),this.state.productType=t.productType,this.state.options=t,common.commonFun(this),"news"===t.productType){t.hasOwnProperty("qunzhuId")?this.state.qunzhuId=t.qunzhuId:this.state.qunzhuId=0;var e=common.getStorage("commentInfo");this.store({commentInfo:e,productType:this.state.productType}),this.state.commentId=e.id,this.state.userId=e.publisher.id,this.getReplyList(0)}if("activity"===t.productType){if(t.hasOwnProperty("count")&&(this.state.count=t.count),t.hasOwnProperty("type")){var a=!0;"false"===t.type&&(a=!1),this.store({isReply:a})}this.state.activityId=t.id,this.getData(0)}},onUnload:function(){wx.removeStorageSync("commentInfo")},getReplyList:function(t){var e=this,a=common.getStorage("commentInfo").id,i="/comment/"+a+"/reply/?offset="+t+"&limit="+e.state.limit;util.httpRequest(i).then(function(a){var i=common.dataListHandle(e,a,e.data.replyInfo,t);wx.hideLoading(),e.store({replyInfo:i.list})})},submitReply:function(t){wx.showLoading({title:"",mask:!0});var e=this,a="/comment/"+e.state.commentId+"/reply/?product="+e.state.productType,i=t.detail.value.pinglun;if(0===i.length)return void common.showTimeToast("请输入评论内容");var s={wx_form_id:t.detail.formId,content:i,ref_uid:e.state.huifuId};util.httpRequest(a,s,"POST").then(function(t){if(wx.hideLoading(),"fail"===t.result)return void common.showClickModal(t.msg);var a=e.data.replyInfo;a.push(t.comment),e.store({replyInfo:a,is_reply:!1,contentVal:""})})},gotolistPage:function(t){var e=t.currentTarget.dataset.index,a=this.data.commentInfo[e];common.setStorage("commentInfo",a),wx.navigateTo({url:"/pages/comment/comment?productType=news"})},huifu:function(t){var e=this;e.state.huifuId=t.currentTarget.dataset.uid;var a=t.currentTarget.dataset.uname,i=t.currentTarget.dataset.commentid,s=e.data.myInfo.id;e.state.commentId=i;var o=["回复"];Number(e.state.qunzhuId)===s&&Number(e.state.huifuId)!==s?o=["回复","删除"]:Number(e.state.huifuId)===s&&(o=["删除"]),wx.showActionSheet({itemList:o,itemColor:"#333333",success:function(t){if(0===t.tapIndex)if(Number(e.state.huifuId)===s){var o="/comment/"+i+"/delete/?product="+e.state.productType;util.httpRequest(o,{},"PUT").then(function(t){e.getReplyList(0)})}else e.store({showInput:"show",isFocus:!0,placeholderVal:"回复"+a+"：",is_reply:!0});else if(1===t.tapIndex){var n="/comment/"+i+"/delete/?product="+e.state.productType;util.httpRequest(n,{},"PUT").then(function(t){e.getReplyList(0)})}},fail:function(t){console.log(t.errMsg)}})},getData:function(t){var e=this,a=this.state.activityId,i="/activity/"+a+"/comment/?offset="+t+"&limit="+this.state.limit+"&order=recent";util.httpRequest(i).then(function(a){a.count>0&&a.results.forEach(function(t){var e=[];if(t.rating){for(var a=1;a<=5;a+=1)t.rating/2>=a?e.push("https://www.haojian.cn/wximg/mall/star_act.png"):e.push("https://www.haojian.cn/wximg/mall/star_def.png");t.grade=e}});var i=common.dataListHandle(e,a,e.data.comments,t);e.setData({comments:i.list,requestStatus:!0,interfaceName:"activityLiuyan",productType:e.state.productType})})},inputBlur:function(){this.store({isFocus:!1,placeholderVal:"输入回复内容..."})},inputVal:function(t){var e=t.detail.value;this.store({lyVal:e})},seeBigImg:function(t){if("news"===this.state.productType){var e=t.currentTarget.dataset.imgurl,a=this.data.commentInfo.attachments;common.seeBigImg(2,e,a)}if("activity"===this.state.productType){var i=t.currentTarget.dataset.index,s=t.currentTarget.dataset.imgurl,o=this.data.comments[i].attachments;common.seeBigImg(2,s,o)}},onReachBottom:function(){if("news"===this.state.productType){if(!this.state.hasmore)return;wx.showLoading({title:"加载中...",mask:!0}),this.state.offset+=this.state.limit,this.getReplyList(this.state.offset)}if("activity"===this.state.productType){if(!this.state.isOnReachBottom)return;if(!this.state.hasmore)return;wx.showLoading({title:"加载中...",mask:!0}),this.state.offset+=this.state.limit,this.getData(this.state.offset),this.state.isOnReachBottom=!1}},store:function(t){this.setData(t)}});