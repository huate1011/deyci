"use strict";var common=getApp().globalData.commonFun,util=getApp().globalData.utilFun,dataTemp=getApp().globalData.dataTempFun,WxParse=require("../../../../wxParse/wxParse");Page({data:{interfaceName:"newsDetail",contactStatus:!0,placeholderVal:"输入评论内容...",contentVal:"",isFocus:!1,adStatus:!0,banner:[],showInput:"hide",shareAlter:"hide",shareAlter1:"hide",is_reply:!1,screenHeight:"100%",openType:"navigateTo",toView:"pageTop",requestStatus:!1,logoPosBottom:!1},tabOffsetTop:null,state:{offset:0,limit:10,pageOnshow:!1,hasmore:!0,isOnReachBottom:!1,queryTop:0},onLoad:function(t){console.log(t),wx.showLoading({title:"加载中...",mask:!0});var e=decodeURIComponent(t.scene);console.log(e);var a={};if("undefined"!==e){var o=e.split("#");a={newsId:o[0],uid:o[1]}}else a=t;console.log(a),this.state.options=a;var i=this;common.getAccessToken()?i.getConfig(a.newsId):getApp().globalData.tokenUpdated=function(){i.getConfig(a.newsId)}},getConfig:function(t){var e=this;common.configData("news",function(){common.commonFun(e),e.getDetail(t)})},onUnload:function(){var t=this.state.options,e=this.data.detail;t.hasOwnProperty("index")&&(t.hasOwnProperty("collect")&&t.collect?!e.isCollect&&getApp().globalData.updateCollectList&&getApp().globalData.updateCollectList(t.index):getApp().globalData.newMovementCallback&&getApp().globalData.newMovementCallback(t.index,t.newsId,e))},onShow:function(){if(this.state.pageOnshow){var t="/news/"+this.state.options.newsId+"/",e=this,a=this.data.detail;util.httpRequest(t).then(function(t){wx.setNavigationBarTitle({title:t.title}),a.views=t.views,a.datetime=t.datetime,a.comment_count=t.comment_count,a.config=t.config,a.status=t.status,a.hasOwnProperty("hongbao_pool")&&(a.hongbao_pool=t.hongbao_pool),e.setData({detail:a}),e.state.offset=0,e.getLikeList(),e.getComment(0)})}},getDetail:function(t){common.shareLog(this,2,t);var e="/news/detail/"+t+"/",a=this;util.httpRequest(e).then(function(t){if("success"===t.result){var e=t.results;wx.setNavigationBarTitle({title:e.title}),a.setData({detail:e,requestStatus:!0}),e.attachments.length>0&&"circle"===e.list_view_type&&e.attachments.forEach(function(t){e.info+='<img src="'+t.original_url+'" />'}),wx.pro.fromSync(function(t){if(e.info){var o=WxParse.wxParse("article","html",e.info,a,5);a.setData(o)}}),a.getComment(0),a.getLikeList(),dataTemp.getBanner(a,"news_detail"),a.state.pageOnshow=!0,common.updateTabOffsetTop(a)}else common.showClickModal(t.msg);wx.hideLoading()})},shareEvent:function(t){t.name="news",t.id=this.state.options.newsId,dataTemp.detailShare(this,t)},inputBlur:function(){this.store({isFocus:!1,showInput:"hide",is_reply:!1,placeholderVal:"输入评论内容..."})},inputVal:function(t){this.store({contentVal:t.detail.value})},onBackTop:function(){wx.pageScrollTo({scrollTop:0})},scrollPinglun:function(t){t.id=this.data.detail.id,t.typeid=3,t.remark="news_detail",common.getFormId(t),wx.pageScrollTo({scrollTop:this.tabOffsetTop})},onPageScroll:function(t){common.goTopEvent(this,t.scrollTop)},onReachBottom:function(){this.state.isOnReachBottom&&this.state.hasmore&&(wx.showLoading({title:"加载中...",mask:!0}),this.state.offset=this.state.offset+this.state.limit,this.getComment(this.state.offset),this.state.isOnReachBottom=!1)},lower:function(t){this.state.isOnReachBottom&&this.state.hasmore&&(wx.showLoading({title:"加载中...",mask:!0}),this.state.offset=this.state.offset+this.state.limit,this.getComment(this.state.offset),this.state.isOnReachBottom=!1)},store:function(t){this.setData(t)},gotolistPage:function(t){var e=t.currentTarget.dataset.index,a=this.data.commentInfo[e];common.setStorage("commentInfo",a),wx.navigateTo({url:"/pages/comment/comment?productType=news"})},getLikeList:function(){var t="/news/"+this.data.detail.id+"/like/?offset=0&limit=10";dataTemp.dianzanList(this,t)},dianzan:function(t){var e=this;t.id=this.data.detail.id,t.typeid=3,t.remark="news_detail_zan",common.getFormId(t),common.wxAuthorize(e,function(a){a&&e.newsDianzan(t)})},collect:function(t){var e=this.data.detail;t.id=e.id,t.typeid=3,t.remark="news_collect",common.getFormId(t),t.typeName="news",t.types=e.isCollect?"cancel":"collect";var a=this;common.collect(t,function(t){a.getDetail(e.id)})},newsDianzan:function(t){var e=this.data.detail,a=t.currentTarget.dataset.method,o="/news/"+e.id+"/like/";"DELETE"===a&&(o="/news/"+e.id+"/like/delete/"),dataTemp.dianzan(this,o,a)},getComment:function(t){var e="/news/"+this.data.detail.id+"/comment/?offset="+t+"&limit="+this.state.limit;dataTemp.pinglunList(this,e,t)},openComment:function(t){t.id=this.data.detail.id,t.typeid=3,t.remark="news_detail_comment",common.getFormId(t);var e=this;common.setStorage("commentImgUrl",e.data.detail.attachments[0].thumb_small_url),wx.navigateTo({url:"/pages/comment/commentShop/commentShop?id="+e.data.detail.id+"&type=newsDetail&ispoint="+e.data.detail.config.ispoint})},huifu:function(t){var e=t.currentTarget.dataset.commentid,a="/comment/"+e+"/delete/?product=news";t.pageType="newsDetail",dataTemp.huifuPinglun(this,a,t)},submitReply:function(t){var e="/comment/"+this.state.commentId+"/reply/?product=news";dataTemp.subReply(this,e,t)},onShareAppMessage:function(t){var e=this.data.detail,a=this.data.myInfo.id,o=this.state.options.newsId;this.setData({shareAlter:"hide"});var i=this.data.config.news;return console.log(i),{title:1==i.isShareCover?e.title:"",path:"pages/newMovement/pages/newsDetail/newsDetail?formType=1&newsId="+o+"&uid="+a,imageUrl:1==i.isShareCover?e.share_img:""}}});