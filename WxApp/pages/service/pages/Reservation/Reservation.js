"use strict";var util=getApp().globalData.utilFun,common=getApp().globalData.commonFun,getPhone=getApp().globalData.phoneFun,inputChange=getApp().globalData.inputFun,yuexpert=require("../../../commonPage/yuexpert/temp.js"),payTempImport=getApp().globalData.payTemp,payEvent=getApp().globalData.payEvent;Page({data:{interfaceName:"serviceConfirm",payAndBingPhoneStatus:!1,contactStatus:!0,peise:getApp().globalData.peise,detail:{},index:0,index2:0,skills:[],skill:"",money:"",moneys:[],Total:0,memberTotal:0,person:1,showView:!1,showView2:!0,lists:[],service_class:"hide",Hoteldisplay:"hide",currentTab:0,txtdis:"block",count:1,timeTab:-1,txtval:"",textarea_t:!0,weeks:[],times:[],chosedTime:"",chosedClock:"",daydates:"",monidx:"",year:"",seletime:"",date:"",numberValue:"",nameValue:"",inputarr:[],theme:"",dis:"true",Clockdis:"block",Clockdis2:"none",hotelweeks:["日","一","二","三","四","五","六"],ymd:"",ymd2:[],ymd3:[],months:[],monthnext:[],monthlast:[],left:"",left2:"",left3:"",flag:1,ym1:"",ym2:"",index1:"",prices:[]},state:{inputVal:[],memMoney:{},memberMoney:0,Population:1},onLoad:function(t){wx.showLoading({title:"加载中...",mask:!0}),this.state.options=t;var a=this;common.payAndBingPhoneSetData(a,function(t){a.setData({payAndBingPhoneStatus:!0})}),common.getAccessToken()?(common.commonFun(a),a.getDetail(t.id),a.getData(),common.getWallet(a)):getApp().globalData.tokenUpdated=function(){console.log("update success"),common.commonFun(a),common.getWallet(a),a.getDetail(t.id),a.getData()};var e=getApp().globalData.confirmService;e&&this.setData({chosedTime:e.chosedTime,chosedClock:e.chosedClock,theme:e.theme,daydates:e.daydates}),yuexpert.getYMD(this)},onUnload:function(){var t=this.state.options;getApp().globalData.serviceUpdateDetailData(),t.hasOwnProperty("index")&&getApp().globalData.serviceUpdateData(t.index)},getDetail:function(t){var a="/api/ExpertToClient/getExpertDetails?id="+t,e=this;util.httpRequest(a,{},"GET","v2").then(function(t){for(var a=[],s=[],i=[],n=0;n<t.data.ExpertItem.length;n+=1)i.push(t.data.ExpertItem[n].name),a.push(t.data.ExpertItem[n].price),s.push(t.data.ExpertItem[n].memberPrice);e.state.Population=t.Population,e.state.memMoney=s,e.setData({detail:t.data,moneys:a,skills:i,weeks:t.data.weekNum,times:t.data.timeStr,numberValue:common.getStorage("userInfo").phone,importValue:common.getStorage("userInfo").phone,nameValue:common.getStorage("userInfo").displayname}),wx.hideLoading()})},getData:function(){var t=this;util.httpRequest("/api/ExpertToClient/getField",{},"GET","v2").then(function(a){wx.hideLoading(),"success"===a.result?(t.setData({CustomRemark:a.CustomRemark,texts:a.data,inputArr:a.data,lists:a.data}),inputChange.inputData(t,a.data)):common.prompt(404,a.msg)})},bindPhoneNumber:function(t){t.pageName="setPageVal",getPhone.phoneChange(this,t)},listenerPickerSelected:function(t){var a=t.detail.value;if(a){console.log(this.data.moneys);var e=(Number(this.data.moneys[a])*Number(this.data.person)).toFixed(2),s=(Number(this.state.memMoney[a])*Number(this.data.person)).toFixed(2);this.state.memberMoney=Number(this.state.memMoney[a]),this.setData({skill:this.data.skills[a],money:Number(this.data.moneys[a]),Total:e,memberTotal:s})}},listenerPickerSelected2:function(t){var a=Number(this.data.money)*Number(this.data.peoples[t.detail.value]);this.setData({index2:t.detail.value,person:this.data.peoples[t.detail.value]}),isNaN(a)?wx.showModal({title:"提示",content:"请选择服务选项",showCancel:!1}):this.setData({Total:a.toFixed(2)})},listendate:function(t){this.setData({date:t.detail.value})},listentime:function(t){this.setData({seletime:t.detail.value})},nameInput:function(t){this.setData({nameValue:t.detail.value})},numberInput:function(t){this.setData({importValue:t.detail.value})},inputEvent:function(t){inputChange.eventChange(this,t)},inputSubmit:function(t){t.id=this.data.detail.id,t.typeid=30,t.remark="service_zhuanjia",common.getFormId(t);var a=t.detail.value,e=this.state.inputVal,s=[];e.forEach(function(t,a){e[a].answer=e[a].value}),s.push({expert_id:this.data.detail.id,item_id:this.data.detail.ExpertItem[a.service].id,count:this.data.person});var i={snapName:this.data.nameValue,snapPhone:this.data.importValue,re_day:this.data.chosedTime,re_time:this.data.chosedClock,remark:this.data.txtval,orderJson:JSON.stringify(s),filedJson:JSON.stringify(e)};if(common.isNull(this.data.skill))return void common.showClickModal("请选择服务选项");if(this.state.submitVals=i,Number(this.data.Total)>0){var n=Number(this.data.Total),o=Number(this.data.memberTotal),h=n-o;this.setData({showPayMethod:!0,useCode:!1,total_money:this.data.detail.member.isMember?o:n,discount:this.data.detail.member.isMember?h:0})}else this.submitConfirm(i)},payEvent:function(t){payTempImport.payChangeEvent(this,t)},callPayment:function(t,a,e,s){if(this.state.formId=e,"wallet"===a)this.setData({payTk:"show",Board:"show"});else{var i=t.state.submitVals;i.payType="weixin",this.submitConfirm(i)}},walletPay:function(t){this.setData({payTk:"hide"});var a=t.state.submitVals;a.payType="wallet",a.password=this.data.passwords,this.submitConfirm(a),payEvent.passwordClear(this)},submitConfirm:function(t){var a=this;wx.showLoading({title:"提交中...",mask:!0});payTempImport.wxPayEvent("/api/ExpertToClient/order",t,"v2",function(t,e){a.resultAlter(e)})},shopListEvent:function(t){var a=t.currentTarget.dataset;a.name="payAlter",common.openUrl(a,this),"ggHide"===a.types&&wx.redirectTo({url:"/pages/service/pages/Myoders/Myoders"})},resultAlter:function(t){var a=this;wx.showModal({title:"提示",content:t,icon:"loading",showCancel:!1,success:function(){common.getAlter(a,"paypop",function(t,e){"show"===e?a.setData({alter:t,alterHidden:e}):wx.redirectTo({url:"/pages/service/pages/Myoders/Myoders"})})}})},BombBox:function(){1==this.data.theme?this.setData({Bgheight:wx.getSystemInfoSync().windowHeight+"px",service_class:"hide",Hoteldisplay:"block",txtdis:"none"}):this.setData({Bgheight:wx.getSystemInfoSync().windowHeight+"px",service_class:"block",Hoteldisplay:"hide",txtdis:"none"})},add0:function(){var t=Number(this.data.person);if(t<Number(this.state.Population)){var a=this.data.money;t+=1;var e=Number(a)*t,s=(Number(this.state.memberMoney)*Number(t)).toFixed(2);this.setData({person:t,Total:e,memberTotal:s})}},subtract0:function(){var t=Number(this.data.person),a=this.data.money;if(t>1){t-=1;var e=Number(a)*t,s=(Number(this.state.memberMoney)*Number(t)).toFixed(2);this.setData({person:t,Total:e,memberTotal:s})}},choseday:function(t){var a=t.currentTarget.dataset.days,e=t.currentTarget.dataset.co+1,s=t.currentTarget.dataset.co;if(e<10)var e="0"+e;else var e=e;this.setData({monthnext:this.data.monthnext,monthlast:this.data.monthlast,months:this.data.months});var i=this.data.flag;if(2==i){var n=a+"-"+e;this.setData({flag:1}),console.log("离店时间"+n);var o=new Date(Date.parse(n.replace(/-/g,"/"))).getTime(),h=new Date(Date.parse(this.data.ym1.replace(/-/g,"/"))).getTime(),l=(o-h)/864e5;this.data.index1;if(l<0)this.data.months[s].state=0,this.setData({flag:2});else if(0==l)this.data.months[s].state=1,this.setData({flag:2});else{this.data.months[s].state=1;for(var m=this.data.index1;m<=s;m++)this.data.months[m].state=1;this.setData({months:this.data.months,chosedTime:this.data.ym1,chosedClock:n,daydates:l});var r=this;setTimeout(function(){r.detailClose()},500)}console.log("总共"+l+"天")}else{var h=a+"-"+e;i++;for(var d=0;d<this.data.months.length;d++)this.data.months[d].state=0;for(var t=0;t<this.data.monthnext.length;t++)this.data.monthnext[t].state=0;for(var c=0;c<this.data.monthlast.length;c++)this.data.monthlast[c].state=0;this.setData({months:this.data.months,monthnext:this.data.monthnext,monthlast:this.data.monthlast});var u=h.replace(/\-/gi,"/"),p=this.data.ymdd.replace(/\-/gi,"/");new Date(u).getTime()<new Date(p).getTime()?(this.data.months[s].state=0,wx.showModal({title:"温馨提示",content:"请选择当前较大时间",showCancel:!1})):(this.data.months[s].state=1,this.setData({flag:i,ym1:h,months:this.data.months,index1:s})),console.log("入住时间"+h)}},choseday2:function(t){var a=t.currentTarget.dataset.days,e=t.currentTarget.dataset.co+1,s=t.currentTarget.dataset.co;if(e<10)var e="0"+e;else var e=e;this.setData({monthnext:this.data.monthnext,monthlast:this.data.monthlast,months:this.data.months});var i=this.data.flag;if(2==i){var n=a+"-"+e;this.setData({flag:1,ym2:n}),console.log(this.data.flag),console.log("离店时间"+n);var o=new Date(Date.parse(n.replace(/-/g,"/"))).getTime(),h=new Date(Date.parse(this.data.ym1.replace(/-/g,"/"))).getTime(),l=this.data.ym1.split("-"),m=this.data.ym2.split("-");l=12*parseInt(l[0])+parseInt(l[1]),m=12*parseInt(m[0])+parseInt(m[1]);var r=Math.abs(l-m),d=(o-h)/864e5,c=this.data.index1;if(d<0)this.data.monthnext[s].state=0,this.setData({flag:2});else if(0==d)this.data.monthnext[s].state=1,this.setData({flag:2});else{if(0==r)for(var u=this.data.index1;u<=s;u++)this.data.monthnext[u].state=1;else{console.log(this.data.months.length);for(var p=c;p<this.data.months.length;p++)this.data.months[p].state=1,this.setData({months:this.data.months});for(var g=0;g<=s;g++)this.data.monthnext[g].state=1}this.setData({chosedTime:this.data.ym1,chosedClock:n,daydates:d});var f=this;setTimeout(function(){f.detailClose()},500)}this.setData({monthnext:this.data.monthnext}),console.log("总共"+d+"天")}else{var h=a+"-"+e;i++;for(var v=0;v<this.data.months.length;v++)this.data.months[v].state=0;for(var t=0;t<this.data.monthnext.length;t++)this.data.monthnext[t].state=0;for(var x=0;x<this.data.monthlast.length;x++)this.data.monthlast[x].state=0;this.setData({months:this.data.months,monthnext:this.data.monthnext,monthlast:this.data.monthlast});for(var v=0;v<this.data.monthnext.length;v++)this.data.monthnext[v].state=0;this.data.monthnext[s].state=1,this.setData({flag:i,ym1:h,monthnext:this.data.monthnext,index1:s}),console.log(this.data.flag),console.log("入住时间"+h)}},choseday3:function(t){var a=t.currentTarget.dataset.days,e=t.currentTarget.dataset.co+1,s=t.currentTarget.dataset.co;if(e<10)var e="0"+e;else var e=e;this.setData({monthnext:this.data.monthnext,monthlast:this.data.monthlast,months:this.data.months});var i=this.data.flag;if(2==i){var n=a+"-"+e;this.setData({flag:1,ym2:n}),console.log(this.data.flag),console.log("离店时间"+n);var o=new Date(Date.parse(n.replace(/-/g,"/"))).getTime(),h=new Date(Date.parse(this.data.ym1.replace(/-/g,"/"))).getTime(),l=this.data.ym1.split("-"),m=this.data.ym2.split("-");l=12*parseInt(l[0])+parseInt(l[1]),m=12*parseInt(m[0])+parseInt(m[1]);var r=Math.abs(l-m);console.log("相差"+r);var d=(o-h)/864e5,c=this.data.index1;if(d<0)this.data.monthlast[s].state=0,this.setData({flag:2});else if(0==d)this.data.monthlast[s].state=1,this.setData({flag:2});else{if(0==r)for(var u=c;u<=s;u++)this.data.monthlast[u].state=1;else if(1==r){for(var p=c;p<this.data.monthnext.length;p++)this.data.monthnext[p].state=1,this.data.monthlast[s].state=1;for(var g=0;g<s;g++)this.data.monthlast[g].state=1}else{for(var f=0;f<this.data.monthnext.length;f++)this.data.monthnext[f].state=1;for(var p=c;p<this.data.months.length;p++)this.data.months[p].state=1;for(var g=0;g<=s;g++)this.data.monthlast[g].state=1}this.setData({months:this.data.months,monthnext:this.data.monthnext,monthlast:this.data.monthlast,chosedTime:this.data.ym1,chosedClock:n,daydates:d});var v=this;setTimeout(function(){v.detailClose()},500)}console.log("总共"+d+"天")}else{var h=a+"-"+e;i++;for(var x=0;x<this.data.months.length;x+=1)this.data.months[x].state=0;for(var t=0;t<this.data.monthnext.length;t+=1)this.data.monthnext[t].state=0;for(var y=0;y<this.data.monthlast.length;y+=1)this.data.monthlast[y].state=0;this.setData({months:this.data.months,monthnext:this.data.monthnext,monthlast:this.data.monthlast});for(var x=0;x<this.data.monthlast.length;x+=1)this.data.monthlast[x].state=0;this.data.monthlast[s].state=1,this.setData({flag:i,ym1:h,monthlast:this.data.monthlast,index1:s}),console.log(this.data.flag),console.log("入住时间"+h)}},detailClose:function(){this.setData({service_class:"hide",txtdis:"block",Hoteldisplay:"hide"})},timebarTap:function(t){yuexpert.selectTime(this,t)},navbarTap:function(t){var a=t.currentTarget.dataset.idx;this.setData({currentTab:a,timeTab:-1,dis:!0})},Reservation:function(){this.setData({chosedClock:this.data.times[this.data.currentTab].time[this.data.timeTab],chosedTime:this.data.weeks[this.data.currentTab].Ymd}),this.detailClose()},textarea1:function(t){var a=t.currentTarget.dataset.val;"填写备注信息"===a&&(a=""),this.setData({txtval:a,textarea_t:!1})},textarea2:function(t){this.setData({txtval:t.detail.value,textarea_t:!0})},textarea3:function(t){this.setData({beizhu:t.detail.value})},store:function(t){this.setData(t)}});