"use strict";var WxParse=require("../../../../wxParse/wxParse.js"),common=getApp().globalData.commonFun,util=getApp().globalData.utilFun,inputChange=getApp().globalData.inputFun,getPhone=getApp().globalData.phoneFun,payTemp=getApp().globalData.payTemp;Page({data:{interfaceName:"form_detail",payAndBingPhoneStatus:!1,adStatus:!0,requestStatus:!1,logoPosBottom:!1,detail:"",lists:[],chooseDateTime:"",chooseDate:"",chooseTime:""},state:{inputVal:[],options:{},feeId:0},onLoad:function(t){wx.showLoading({title:"加载中...",mask:!0}),this.state.options=t;var e=this;common.payAndBingPhoneSetData(e,function(t){e.setData({payAndBingPhoneStatus:!0})}),this.state.formId=t.formid,common.getAccessToken()?(common.commonFun(e),common.getWallet(e),e.getFromDetail()):getApp().globalData.tokenUpdated=function(){console.log("update success"),common.commonFun(e),common.getWallet(e),e.getFromDetail()}},onShareAppMessage:function(t){var e=this.data.detail,o=common.getStorage("userInfo").id;return{title:e.title,path:"pages/form/pages/formDetail/formDetail?formType=1&formid="+e.id+"&uid="+o}},store:function(t){this.setData(t)},getFromDetail:function(){common.shareLog(this,15,this.state.formId);var t=this,e="/form/detail/"+t.state.formId+"/";util.httpRequest(e).then(function(e){if("success"===e.result){var o=e.results;if(o.fees.length>1){var a=0;o.fees.forEach(function(t,e){0===e?a=t.fee:Number(a)>Number(t.fee)&&(a=t.fee)}),o.minMoney=a}t.store({detail:o,lists:o.inputs,requestStatus:!0,numberValue:common.getStorage("userInfo").phone});var n=WxParse.wxParse("article","html",o.info,t,5);t.store(n),inputChange.inputData(t,o.inputs)}else common.showClickModal(e.msg);wx.hideLoading()})},checkFeeType:function(t){console.log(t);var e=t.detail.value,o=this.data.detail.fees;this.setData({total_money:o[e].fee}),this.state.feeId=o[e].id},formSubmit:function(t){var e=this,o=this.data.detail,a=(t.detail.value,t.detail.formId);if(o.fees&&o.fees.length>0&&0===Number(this.state.feeId))return void common.showTimeToast("请选择费用类型");if(this.data.total_money>0&&!this.data.iphoneShow)return void common.showClickModal("当前小程序暂不支持该功能");var n=this.state.inputVal;console.log(n);var i=this;if(n.length>0)inputChange.contentJudge(i,function(t){var o={wx_form_id:a,fee_item_id:i.state.feeId,inputs:n};e.submitForm(o)});else{var s={wx_form_id:a,fee_item_id:i.state.feeId,inputs:[]};this.submitForm(s)}},submitForm:function(t){var e=this,o="/form/"+this.state.formId+"/";wx.showLoading({title:"数据提交中...",mask:!0}),util.httpRequest(o,t,"POST").then(function(o){if("success"===o.result)if(e.data.total_money>0){var a="/formOrder/"+o.form.shop_order_id+"/payment/",n={wx_form_id:t.wx_form_id,method:"pay",platform:"weixin"};payTemp.payment(e,a,n,function(t,o){"success"===t?e.submitEnd("支付成功！"):e.submitEnd(o)})}else e.submitEnd("表单提交成功！");else common.showClickModal(o.msg)})},submitEnd:function(t){wx.hideLoading();var e=this;wx.showModal({title:"提示",content:t,showCancel:!1,success:function(t){common.getAlter(this,"paypop",function(t,o){"show"===o?e.setData({alter:t,alterHidden:o}):wx.redirectTo({url:"/pages/form/pages/formOrder/formOrder"})})}})},shopListEvent:function(t){var e=t.currentTarget.dataset;e.name="payAlter",common.openUrl(e,this),"ggHide"===e.types&&wx.redirectTo({url:"/pages/form/pages/formOrder/formOrder"})},inputEvent:function(t){inputChange.eventChange(this,t)},bindPhoneNumber:function(t){t.pageName="setPageVal",getPhone.phoneChange(this,t)}});