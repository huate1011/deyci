"use strict";function shopCartEvent(t){shopCartChangeEvent(this,t)}function cartList(t,e){t.shopCartEvent=shopCartEvent;var o="/cart/?acid="+getApp().globalData.acid;util.httpRequest(o,{},"GET").then(function(o){o.results=o.sku;var a=common.dataListHandle(t,o,t.data.list,e);a.list.forEach(function(t,e){a.list[e].kc=!1,a.list[e].checked=!1}),t.store({list:a.list,is_selectAll:!1,requestStatus:!0,logoPosBottom:!0})})}function selectCartGoods(t,e){var o=e.index,a=Number(t.data.totalNumber),c=Number(t.data.totalMoney),u=t.data.selectCount,r=!0,i=t.data.list;i[o].checked=!i[o].checked,i.forEach(function(t){t.checked||(r=!1)});var s=Number(i[o].count)*Number(i[o].price);i[o].checked?(u+=1,a+=Number(i[o].count),c+=s):(a-=Number(i[o].count),c-=s,u-=1),t.store({list:i,is_selectAll:r,totalNumber:a,totalMoney:c.toFixed(2),selectCount:u})}function cartSelectAll(t){var e=t.data.list,o=0,a=0,c=0;e.forEach(function(u,r){t.data.is_selectAll?(e[r].checked=!1,o=0,c=0):(e[r].checked=!0,o+=Number(u.count),a+=Number(u.count)*Number(u.price),c=e.length)}),t.store({list:e,is_selectAll:!t.data.is_selectAll,totalNumber:o,totalMoney:a.toFixed(2),selectCount:c})}function numEvent(t){var e=t.data.list,o=[];e.forEach(function(t){var e={sku_id:t.sku_id,count:Number(t.count),price:t.price};o.push(e)});var a={cartsku:o},c="/cart/?acid="+getApp().globalData.acid;util.httpRequest(c,a,"PUT")}function cartAddNumber(t,e){var o=e.index,a=Number(t.data.totalNumber),c=Number(t.data.totalMoney),u=t.data.list;u[o].count<u[o].sku.stock_count&&(u[o].count+=1,u[o].checked&&(a+=1,c+=Number(u[o].price)),numEvent(t)),t.store({list:u,totalNumber:a,totalMoney:c.toFixed(2)})}function cartDownNumber(t,e){var o=e.index,a=Number(t.data.totalNumber),c=Number(t.data.totalMoney),u=t.data.list;u[o].count>1&&(u[o].count-=1,u[o].checked&&(a-=1,c-=Number(u[o].price)),numEvent(t)),t.store({list:u,totalNumber:a,totalMoney:c.toFixed(2)})}function cartEdit(t){var e=t.data.list,o=0,a=0,c=[];e.forEach(function(t){if(t.checked){o+=Number(t.count),a+=Number(t.price)*Number(t.count);var e={sku_id:t.sku_id,count:t.count,price:t.price};c.push(e)}});var u={cartsku:c,module:"shop"};util.httpRequest("/order/price/",u,"POST").then(function(o){o.order.detail.forEach(function(t,o){e.forEach(function(o,a){o.checked&&t.id===o.id&&(Number(o.count)>Number(o.sku.stock_count)?e[a].kc=!0:e[a].kc=!1)})}),t.setData({list:e})}),t.store({is_edit:!t.data.is_edit,totalNumber:o,selectCount:o,totalMoney:Number(a).toFixed(2)})}function cartGoPay(t){if(t.data.selectCount>0){wx.showLoading({title:"请等待...",mask:!0});var e=t.data.list,o=[],a=0,c=[];e.forEach(function(t){if(t.checked){var e={count:Number(t.count),sku_id:t.sku_id,stock_count:Number(t.sku.stock_count),price:t.price,isMemberProduct:t.isMemberProduct,normal_product:t.normal_product,alias:t.alias,title:t.title,url:t.sku.preview.thumb_medium_url,inputs:t.inputs};c.push(e),a+=Number(t.count)}var u={sku_id:t.sku_id,count:t.count,price:t.price,isMemberProduct:t.isMemberProduct,normal_product:t.normal_product,inputs:t.inputs};o.push(u)});var u={cartsku:{cartsku:o},skuData:c,totalNum:a,totalMoney:t.data.totalMoney},r={cartsku:o,module:"shop"};util.httpRequest("/order/price/",r,"POST").then(function(o){if(wx.hideLoading(),"success"===o.result){var a=o.order.detail,c=!1;a.forEach(function(t,o){e.forEach(function(o,a){o.checked&&t.id===o.id&&(Number(o.count)>Number(o.sku.stock_count)?(e[a].kc=!0,c=!0):e[a].kc=!1)})}),c?t.setData({list:e}):shopListTemp.addShopCar(u,"shopCart",t)}else common.showClickModal(o.msg)})}else common.showClickModal("您还未选择任何商品！")}function cartDeletaShop(t){if(0===t.data.selectCount)return void common.showClickModal("请选择需要删除的商品！");var e=t.data.list,o=[];e.forEach(function(t){if(!t.checked){var e={sku_id:t.sku_id,count:Number(t.count),price:t.price};o.push(e)}});var a={cartsku:o},c="/cart/?acid="+getApp().globalData.acid;util.httpRequest(c,a,"PUT").then(function(e){common.showClickModal("删除成功！"),cartList(t,0)})}function DeletaOneShop(t,e){var o=e.skuid,a=e.index,c=t.data.list;if(c[a].checked){var u=[];c.forEach(function(t){if(t.sku_id!==o){var e={sku_id:t.sku_id,count:Number(t.count),price:t.price};u.push(e)}});var r={cartsku:u},i="/cart/?acid="+getApp().globalData.acid;util.httpRequest(i,r,"PUT").then(function(e){c.splice(a,1),common.showClickModal("删除成功");for(var o=0,u=0,r=0,i=0;i<c.length;i+=1)c[i].checked&&(o+=Number(c[i].count),u+=Number(c[i].count)*Number(c[i].price),r+=1);t.store({list:c,totalNumber:o,totalMoney:u.toFixed(2),selectCount:r})})}}function shopCartChangeEvent(t,e){var o=e.currentTarget.dataset;"selectGoods"===o.types?selectCartGoods(t,o):"selectAll"===o.types?cartSelectAll(t):"downNumber"===o.types?cartDownNumber(t,o):"addNumber"===o.types?cartAddNumber(t,o):"goDetialPage"===o.types?wx.navigateTo({url:"/pages/mall/pages/shopDetail/shopDetail?isMallODOpen=0&productId="+o.id}):"caozuoCart"===o.types?cartEdit(t):"deleteCart"===o.types?cartDeletaShop(t):"goPlay"===o.types?cartGoPay(t):"deleteGoods"===o.types&&DeletaOneShop(t,o)}var common=getApp().globalData.commonFun,util=getApp().globalData.utilFun,shopListTemp=require("./shopListTemp.js");module.exports={shopCartChangeEvent:shopCartChangeEvent,cartList:cartList};