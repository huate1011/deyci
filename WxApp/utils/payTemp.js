"use strict";function payment(e,a,t,s){util.httpRequest(a,t,"POST").then(function(a){if("fail"===a.result)return void s("fail",a.msg);Number(a.payment.amount)>0?"wallet"===t.platform?e.setData({paymentId:a.payment.id,payTk:"show",Board:"show"}):"weixin"===t.platform&&wx.requestPayment({timeStamp:a.payment.weixin.timeStamp,nonceStr:a.payment.weixin.nonceStr,package:a.payment.weixin.package,signType:a.payment.weixin.signType,paySign:a.payment.weixin.paySign,success:function(e){var n={method:"refresh"},o=0;a.payment.hasOwnProperty("orderId")&&(o=a.payment.orderId),a.payment.hasOwnProperty("id")&&(o=a.payment.id);var r="/order/"+o+"/payment/";t.hasOwnProperty("typeName")&&"activity"===t.typeName&&(r="/enroll/"+o+"/payment/"),util.httpRequest(r,n,"POST"),s("success","支付成功")},fail:function(e){console.log(JSON.stringify(e));var a="";a=e.hasOwnProperty("errMsg")?"requestPayment:fail cancel"===e.errMsg?"取消支付":e.errMsg:"支付失败",s("fail",a)}}):s("success",a.msg),wx.hideLoading()}).catch(function(e){s("fail",e.errMsg)})}function wxPayEvent(e,a,t,s){util.httpRequest(e,a,"POST",t).then(function(e){if(wx.hideLoading(),"success"===e.result){if("finish"===e.type)s("success",e.msg?e.msg:"支付成功");else if("waitpay"===e.type){var a=e.data.result;wx.requestPayment({timeStamp:a.timeStamp,nonceStr:a.nonceStr,package:a.package,signType:a.signType,paySign:a.paySign,success:function(e){s("success","支付成功")},fail:function(e){console.log(JSON.stringify(e));var a="";a=e.hasOwnProperty("errMsg")?"requestPayment:fail cancel"===e.errMsg?"取消支付":e.errMsg:"支付失败",s("fail",a)}})}}else{var t=e.err_code;10303===Number(t)||40001===Number(t)||10004===Number(t)?common.showClickModal(e.msg):s("fail",e.msg)}})}function hasCodeFuc(e,a,t){var s=a.data.payId,n=a.data.coupon,o="weixin";1===Number(s)?o="wallet":wx.showLoading({title:"支付中...",mask:!0}),a.setData({showPayMethod:!1,useCode:!1,total_money:a.data.total_money}),n?a.callPayment(a,o,t,n.id):a.callPayment(a,o,t,0)}function surePayMethed(e,a){var t=e.detail.formId;if(a.state.formId=e.detail.formId,e.detail.value.code&&!a.data.coupon)return void payEvent.getCoupon(a,e.detail.value.code,t);hasCodeFuc(e,a,t)}function payRequest(e,a){wx.showLoading({title:"支付中...",mask:!0});var t={type:"pay",payment_id:e.data.paymentId,paypass:e.data.passwords,wx_form_id:e.state.formId};util.httpRequest("/wallet/transaction/",t,"POST").then(function(t){e.setData({payTk:"hide"}),payEvent.passwordClear(e),wx.hideLoading(),a(t)})}function passwordImport(e,a){var t=e.data.passwordLength,s=e.data.showPassword,n=e.data.passwords;t<6&&(s[t]="*",n+=a.target.dataset.number,t+=1,e.setData({showPassword:s,passwords:n,passwordLength:t}),6===t&&e.walletPay(e))}function payChangeEvent(e,a){var t=a.currentTarget.dataset;if("chooseType"===t.types)payEvent.chooseType(a,e);else if("closePayTypeTk"===t.types){var s=e.data.detail;e.state.giveFriends?(e.setData({showPayMethod:!1,isGift:!1,total_money:s.fee}),e.state.giveFriends=!1):e.setData({showPayMethod:!1})}else"closeBaoMing"===t.types?("mall"===a.pageName?e.tiaoZhuan():"diancan"===a.pageName?wx.redirectTo({url:"/pages/dianCan/pages/myTakeout/myTakeout"}):"baoming"===a.pageName&&e.tiaoZhuan(),e.setData({payTk:"hide"}),payEvent.passwordClear(e)):"boardClose"===t.types?(e.setData({Board:"hide"}),payEvent.passwordClear(e)):"boradShow"===t.types?e.setData({Board:"show"}):"delNumber"===t.types?payEvent.passwordDelete(e):"numberClick"===t.types?passwordImport(e,a):"payMethedSure"===t.types&&surePayMethed(a,e)}var util=require("util.js"),common=require("common.js"),payEvent=require("payEvent.js");module.exports={payChangeEvent:payChangeEvent,wxPayEvent:wxPayEvent,payRequest:payRequest,payment:payment};