"use strict";var common=getApp().globalData.commonFun,util=getApp().globalData.utilFun;Page({data:{commentInfo:"",placeholderVal:"输入回复内容...",isFocus:!1,contentVal:"",replyInfo:[],interfaceName:"commonList"},state:{offset:0,limit:30,hasmore:!0},onLoad:function(t){wx.showLoading({title:"加载中...",mask:!0});var e=common.getStorage("commentInfo");this.state.commentId=e.id,this.state.userId=e.publisher.id,t.hasOwnProperty("qunzhuId")?this.state.qunzhuId=t.qunzhuId:this.state.qunzhuId=0,t.hasOwnProperty("productType")&&(this.state.productType=t.productType),this.store({commentInfo:e}),common.commonFun(this)},onShow:function(){this.getReplyList(0)},onUnload:function(){wx.removeStorageSync("commentInfo")},getReplyList:function(t){var e=this,o=common.getStorage("commentInfo").id,n="/comment/"+o+"/reply/?offset="+t+"&limit="+e.state.limit;util.httpRequest(n).then(function(o){var n=common.dataListHandle(e,o,e.data.replyInfo,t);wx.hideLoading(),e.store({replyInfo:n.list})})},submitReply:function(t){wx.showLoading({title:"",mask:!0});var e=this,o="/comment/"+e.state.commentId+"/reply/?product="+e.state.productType,n=t.detail.value.pinglun;if(0===n.length)return void common.showTimeToast("请输入评论内容");var i={wx_form_id:t.detail.formId,content:n,ref_uid:e.state.huifuId};util.httpRequest(o,i,"POST").then(function(t){if(wx.hideLoading(),"fail"===t.result)return void common.showClickModal(t.msg);var o=e.data.replyInfo;"wait_confirm"===t.comment.status?common.showClickModal("评论已提交，等待审核！"):o.push(t.comment),e.store({replyInfo:o,is_reply:!1,contentVal:""})})},huifu:function(t){var e=this;e.state.huifuId=t.currentTarget.dataset.uid;var o=t.currentTarget.dataset.uname,n=t.currentTarget.dataset.commentid,i=e.data.myInfo.id;e.state.commentId=n;var s=["回复"];Number(e.state.qunzhuId)===i&&Number(e.state.huifuId)!==i?s=["回复","删除"]:Number(e.state.huifuId)===i&&(s=["删除"]),wx.showActionSheet({itemList:s,itemColor:"#333333",success:function(t){if(0===t.tapIndex)if(Number(e.state.huifuId)===i){var s="/comment/"+n+"/delete/?product="+e.state.productType;util.httpRequest(s,{},"PUT").then(function(t){e.getReplyList(0)})}else e.store({showInput:"show",isFocus:!0,placeholderVal:"回复"+o+"：",is_reply:!0});else if(1===t.tapIndex){var a="/comment/"+n+"/delete/?product="+e.state.productType;util.httpRequest(a,{},"PUT").then(function(t){e.getReplyList(0)})}},fail:function(t){console.log(t.errMsg)}})},inputBlur:function(){this.store({isFocus:!1,placeholderVal:"输入回复内容..."})},onReachBottom:function(){wx.showLoading({title:"加载中...",mask:!0}),this.state.hasmore&&(this.state.offset+=this.state.limit,this.getReplyList(this.state.offset))},store:function(t){this.setData(t)}});