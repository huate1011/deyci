"use strict";var common=getApp().globalData.commonFun,util=getApp().globalData.utilFun,getPhone=getApp().globalData.phoneFun;Page({data:{howManyNum:0,contactStatus:!0,box:[],txt:[],member:[],userInfo:{},activitytime:"",activityprize:"",activitycontent:"",productcount:"",luckynum:0,content:{index:0,count:0,speed:50,cycle:24},luckytapif:!0,showtk:!1,winlist:[],isMinning:!1,showPrize:!1,prizeInfo:"",nbPhone:!0,phone:"",CountdownVal:["发送验证码","发送验证码","发送验证码","发送验证码"],tankuang:["hide","hide","hide","hide"],CountdownTime:[60,60,60,60],onClick:[!0,!0,!0,!0],bindPhone:!1,clearTimeout:!0,btnPhoneNumber:!1},state:{offset:0,limit:10,hasmore:!0,isOnReachBottom:!0,luckytapif:!0,prize:0,WinningEnd:""},onLoad:function(t){var e=this;e.state.lid=t.id,wx.showLoading({title:"加载中...",mask:!0}),common.getAccessToken()?e.getLotterys():getApp().globalData.tokenUpdated=function(){console.log("update success"),e.getLotterys()}},getLotterys:function(){common.commonFun(this);var t=this,e="/getLotterys?id="+t.state.lid;util.httpRequest(e,{},"GET","v2").then(function(e){if(wx.hideLoading(),"success"===e.result){console.log(e);var i=[],o=e.data.product,a=0,n=0;if(o.length<8)for(var s=0;s<8;s+=1){var l={name:"谢谢参与",img:"https://www.haojian.cn/wximg/market/smile.png"};i.push(l)}else i=o;for(var c=0;c<i.length;c++)o.length<8&&c===a&&n<o.length&&(o[n].img||(o[n].img="https://www.haojian.cn/wximg/market/gift.png"),i.splice(c,1,o[n]),a+=Math.floor(8/o.length),n+=1),i[c].nowName=i[c].name.split("，")[0];t.setData({details:e.data,howManyNum:e.data.datanum,productcount:e.data.product.length,member:e.data.member,winlist:e.data.member,box:i})}else common.showClickModal(e.msg)})},luckyTap:function(){var t=this,e=this.data.howManyNum;if(!common.getStorage("userInfo").phone)return void wx.showModal({title:"提示",content:"请先绑定手机号！",showCancel:!1,success:function(){var e=t.data.tankuang;e[3]="show",t.store({tankuang:e})}});if(this.state.luckytapif){if(this.state.luckytapif=!1,0===e)return wx.showModal({title:"",content:"今日抽奖次数已用完！",showCancel:!1}),void(this.state.luckytapif=!0);var i={id:Number(t.state.lid),uid:common.getStorage("userInfo").id};util.httpRequest("/goDraw/",i,"POST","v2").then(function(i){if(t.state.WinningEnd=i,"success"===i.result){var o=t.data.box.length,a=o-t.data.productcount,n=void 0,s=t.data.box;if(i.product)s.forEach(function(t,e){Number(t.id)===Number(i.product.id)&&(n=e)});else{var l=Math.floor(Math.random()*a)+t.data.productcount;n=l-1}t.state.prize=Math.floor(n);var c=t.data.content;c.count=t.data.box.length,t.store({prizeInfo:i,content:c,howManyNum:e-1}),t.roll()}else t.state.luckytapif=!0,common.showClickModal(i.msg)}).catch(function(t){common.showClickModal(t.data.msg)})}},roll:function(){var t=this.data.content,e=this.state.prize,i=this,o=this.data.prizeInfo;i.data.box[e].id&&!o.product&&(e+=1),t.cycle-(t.count-e)>0?(t.index+=1,t.cycle-=1,this.store({luckynum:t.index%8}),setTimeout(this.roll,t.speed)):t.index<3*t.count+e?(t.index+=1,t.speed+=68.75,this.data.content=t,this.store({luckynum:t.index%8}),setTimeout(this.roll,t.speed)):(t.index=0,t.cycle=24,t.speed=50,this.state.luckytapif=!0,i.getlist(0,"all",!0),o.product?i.store({isMinning:!0,showtk:!0}):i.store({isMinning:!1,showtk:!0}))},getlist:function(t,e,i){var o=this,a=o.data.details,n="/winlist/?offset="+t+"&limit="+o.state.limit+"&lid="+a.id;"all"===e&&(n="/winlist/?offset="+t+"&limit="+o.state.limit+"&lid="+a.id+"&alluser=1"),util.httpRequest(n,{},"GET","v2").then(function(a){if(i)return void o.store({member:a.results});if(0===a.count)return void common.showClickModal("暂无中奖纪录！");var n=common.dataListHandle(o,a,o.data.winlist,t);o.store({prizeNum:a.count,winlist:n.list,showtk:!0,showPrize:!0,showType:e})})},moreModel:function(t){var e=t.currentTarget.dataset.types;this.state.offset=0,this.getlist(0,e)},close:function(t){var e=t.currentTarget.dataset,i=e.index;if(i){var o=this.data.tankuang;o[i]="hide",this.store({tankuang:o})}else this.store({showtk:!1,isMinning:!1,showPrize:!1}),"again"===e.types&&this.luckyTap()},store:function(t){this.setData(t)},lower:function(t){this.state.isOnReachBottom&&this.state.hasmore&&(this.state.offset=this.state.offset+this.state.limit,this.getlist(this.state.offset,this.data.showType),this.state.isOnReachBottom=!1)},onShareAppMessage:function(){return{title:"幸运大抽奖",path:"/pages/market/lottery/index/index?id="+this.state.lid}},bindPhoneNumber:function(t){t.pageName="market",getPhone.phoneChange(this,t)}});