"use strict";var WxParse=require("../../../../../wxParse/wxParse.js"),common=getApp().globalData.commonFun,util=getApp().globalData.utilFun,getPhone=getApp().globalData.phoneFun;Page({data:{interfaceName:"shopDetail",tankuang:["hide","hide","hide","hide"],comments:[],orderNum:1,showGoTop:!1,isPageScrollTo:!1,addressInfo:"",CountdownVal:["发送验证码","发送验证码","发送验证码","发送验证码"],CountdownTime:[60,60,60,60],onClick:[!0,!0,!0,!0],clearTimeout:!0,logoPosBottom:!1},state:{pageOnShow:!1,isOnReachBottom:!0,isonPullDownRefresh:!1,hasmore:!0,offset:0,limit:10},onLoad:function(t){wx.showLoading({title:"加载中...",mask:!0}),this.state.id=t.id;var e=this;common.getAccessToken()?common.commonFun(e):getApp().globalData.tokenUpdated=function(){console.log("update success"),common.commonFun(e)},this.getDetail(t.id)},getDetail:function(t){var e=this,o="/point/shopdetail/"+t+"/",a=this;util.httpRequest(o).then(function(t){a.store({detail:t});var o=WxParse.wxParse("article","html",t.content,a,5);a.store(o),wx.hideLoading(),a.state.pageOnShow=!0,e.getProductComment(0)}).catch(function(t){common.prompt(t.statusCode,t.message)})},onShow:function(){this.state.pageOnShow&&this.getDetail(this.state.id)},store:function(t){this.setData(t)},topIndex:function(){wx.switchTab({url:"/pages/index/page0/page0"})},seeBigImg:function(t){var e=t.currentTarget.dataset.imgurl,o=t.currentTarget.dataset.index;if(o||0===o){var a=this.data.comments[o].attachments;common.seeBigImg(2,e,a)}else common.seeBigImg(1,e,"")},onPageScroll:function(t){var e=t.scrollTop;common.goTopEvent(this,e)},onBackTop:function(){common.isscrollToPage(this)},shopDetailImg:function(t){var e=t.currentTarget.dataset.imgurl,o=t.currentTarget.dataset.num;if(1===Number(o))common.seeBigImg(1,e,"");else{var a=this.data.detail.attachments;common.seeBigImg(2,e,a)}},bindPhoneNumber:function(t){t.pageName="point",getPhone.phoneChange(this,t)},changeAddress:function(){var t=this;common.currentLocation(2,function(e){if(console.log(e),"chooseAddress:ok"===e.errMsg){var o=e;o.name=e.userName,o.tel=e.telNumber,o.address=e.provinceName+e.cityName+e.countyName+e.detailInfo,t.store({addressInfo:o})}})},changeValue:function(t){var e=t.detail.value,o=this.data.detail.stock_count;Number(o)<Number(e)&&(common.showClickModal("超出库存量"),e=Number(o)),this.store({orderNum:e})},blurValue:function(t){var e=t.detail.value;0!==Number(e)&&""!==e||(e=1),this.store({orderNum:e})},downNumber:function(){var t=Number(this.data.orderNum);t>1&&this.store({orderNum:t-=1})},addNumber:function(){var t=Number(this.data.orderNum),e=this.data.detail.stock_count;Number(e)>Number(t)&&this.store({orderNum:t+=1})},closeKF:function(){var t=this.data.tankuang;t[0]="hide",this.store({tankuang:t})},openKFTanKuang:function(){var t=this.data.tankuang;t[0]="show",this.store({tankuang:t})},duihuan:function(){var t=this.data.tankuang;t[2]="show",this.store({tankuang:t})},closeConfirm:function(){var t=this.data.tankuang;t[2]="hide",this.store({tankuang:t})},call:function(t){var e=t.currentTarget.dataset.phone;common.phoneCall(e);var o=this.data.tankuang;o[0]="hide",this.store({tankuang:o})},getProductComment:function(t){var e=this,o=this.data.comments,a="/point/product/"+this.state.id+"/comment/?offset="+t+"&limit="+this.state.limit;util.httpRequest(a).then(function(a){a.count>0&&a.results.forEach(function(t){for(var e=[],o=1;o<=5;o+=1)t.rating/2>=o?e.push("https://www.haojian.cn/wximg/mall/star_act.png"):e.push("https://www.haojian.cn/wximg/mall/star_def.png");t.grade=e});var n=common.dataListHandle(e,a,o,t);e.store({comments:n.list})})},onReachBottom:function(){this.state.isonPullDownRefresh||this.state.isOnReachBottom&&this.state.hasmore&&(wx.showLoading({title:"加载中...",mask:!0}),this.state.offset=this.state.offset+this.state.limit,this.getProductComment(this.state.offset),this.state.isOnReachBottom=!1)},sure:function(t){var e=this,o="/point/"+this.state.id+"/buy/",a={num:this.data.orderNum,point:this.data.detail.point},n=this.data.addressInfo;if(1===Number(this.data.detail.isaddress)){if(!n)return void common.showClickModal("请选择收货地址");if(n.hasOwnProperty("id")&&!n.detail)return void common.showClickModal("请选择收货地址");if(n.hasOwnProperty("id")&&common.isNull(n.name))return void common.showClickModal("请填写完整的信息！");a.address=n.address,a.name=n.name,a.phone=n.tel}else{var s=common.getStorage("userInfo");a.name=s.displayname,a.phone=s.phone,a.address=""}wx.showLoading({title:"提交中...",mask:!0}),util.httpRequest(o,a,"POST").then(function(t){wx.hideLoading(),"success"===t.result?wx.showModal({title:"提示",content:"兑换成功",showCancel:!1,success:function(t){e.store({orderNum:1,addressInfo:""}),e.closeConfirm(),wx.navigateTo({url:"/pages/market/pages/integral/duihuanRecord/duihuanRecord"})}}):wx.showModal({title:"提示",content:t.msg,showCancel:!1,success:function(t){}})})},onShareAppMessage:function(t){return{path:"pages/market/pages/integral/shopDetail/shopDetail?id="+this.state.id,success:function(t){},fail:function(t){}}}});