"use strict";var common=getApp().globalData.commonFun,util=getApp().globalData.utilFun,payTempImport=getApp().globalData.payTemp;Page({data:{interfaceName:"myCard",contactStatus:!0,requestStatus:!1,list:[]},state:{},onLoad:function(t){wx.showLoading({title:"加载中...",mask:!0});var e=common.getAccessToken(),a=this;common.payAndBingPhoneSetData(a,function(t){a.setData({payAndBingPhoneStatus:!0})}),e?(a.grade(),common.commonFun(a),common.getWallet(a)):getApp().globalData.tokenUpdated=function(){console.log("update success"),a.grade(),common.commonFun(a),common.getWallet(a)}},grade:function(){var t=this;util.httpRequest("/wallet/").then(function(e){t.setData({member:e.memberDiscount,mypoint:e.mypoint,totalPoint:e.totalPoint,membName:e.name,memType:e.memberType,grade:e.grade,cash_balance:Number(e.cash_balance).toFixed(2),balance:Number(e.balance).toFixed(2),isSetPayPassword:e.has_pay_password,requestStatus:!0,config:common.getStorage("config"),endtime:e.endtime,gradeId:e.gradeId}),wx.hideLoading(),t.gradeList(e.gradeId)})},gradeList:function(t){var e=this,a=0;util.httpRequest("/member/grade/?offset=0&limit=100").then(function(o){o.results.forEach(function(e,n){o.results[n].grade=!1,Number(e.id)===Number(t)&&(o.results[n].grade=!0,a=e.point)}),e.setData({list:o.results,buyPrice:a}),wx.hideLoading()})},gradeFun:function(t){if(!this.data.iphoneShow)return void common.showClickModal("当前小程序暂不支持该功能");var e=t.detail.target.dataset,a=this.data.list,o=this,n={type:e.type,unit:a[e.index].unit,id:a[e.index].id,productId:a[e.index].productId,wx_form_id:t.detail.formId,action_type:"buy"};wx.showLoading({title:"请求中...",mask:!0}),this.state.val=n,this.state.pId=a[e.index].productId,util.httpRequest("/grade/open/",n,"POST").then(function(t){wx.hideLoading(),"success"===t.result?"paid"===t.detail.status?o.shuaxin():(o.state.orderId=t.detail.id,o.setData({showPayMethod:!0,total_money:t.detail.price.total_price})):common.showTimeToast(t.msg)})},payEvent:function(t){payTempImport.payChangeEvent(this,t)},callPayment:function(t,e,a,o){wx.showLoading({title:"",mask:!0});var n="/member/"+t.state.orderId+"/payment/",i={wx_form_id:a,method:"pay",platform:e,product_id:this.state.pId};payTempImport.payment(this,n,i,function(e,a){"success"===e?t.shuaxin():common.showClickModal(a)})},walletPay:function(t){payTempImport.payRequest(t,function(e){"success"===e.result?t.shuaxin():common.showClickModal(e.msg)})},shuaxin:function(){var t=this,e=this.state.val;e.action_type="check",util.httpRequest("/grade/open/",e,"POST").then(function(e){"success"===e.result?(t.grade(),common.showClickModal("操作成功")):common.showClickModal(e.msg)})},shopListEvent:function(t){var e=t.currentTarget.dataset;e.name="payAlter",common.openUrl(e,this),"ggHide"===e.types&&this.grade()},store:function(t){this.setData(t)}});